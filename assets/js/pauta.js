// ==========================================
// √çCONES E MAPAS (NOVOS)
// ==========================================

const whatsappIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
</svg>`;

const instagramIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
</svg>`;

const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
  <path d="M13 0H6a2 2 0 0 0-2 2 2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 2 2 0 0 0 2-2V4a2 2 0 0 0-2-2 2 2 0 0 0-2-2zM2 4a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4z"/>
  <path d="M13.5 1a.5.5 0 0 0-.5.5V3h-2a.5.5 0 0 0 0 1h2v1.5a.5.5 0 0 0 1 0V4h1.5a.5.5 0 0 0 0-1H14V1.5a.5.5 0 0 0-.5-.5z"/>
</svg>`;

// NOVO: Mapa de Estados
const mapEstados = {
  AC: "Acre",
  AL: "Alagoas",
  AP: "Amap√°",
  AM: "Amazonas",
  BA: "Bahia",
  CE: "Cear√°",
  DF: "Distrito Federal",
  ES: "Esp√≠rito Santo",
  GO: "Goi√°s",
  MA: "Maranh√£o",
  MT: "Mato Grosso",
  MS: "Mato Grosso do Sul",
  MG: "Minas Gerais",
  PA: "Par√°",
  PB: "Para√≠ba",
  PR: "Paran√°",
  PE: "Pernambuco",
  PI: "Piau√≠",
  RJ: "Rio de Janeiro",
  RN: "Rio Grande do Norte",
  RS: "Rio Grande do Sul",
  RO: "Rond√¥nia",
  RR: "Roraima",
  SC: "Santa Catarina",
  SP: "S√£o Paulo",
  SE: "Sergipe",
  TO: "Tocantins",
};

// ==========================================
// DADOS GLOBAIS
// ==========================================
// As vari√°veis pautaSlug, casaLegislativa, etc., precisam ser definidas aqui.
// A forma mais f√°cil √© ler de atributos 'data-' no HTML
const pautaDataElement = document.getElementById("pauta-data");
const pautaSlug = pautaDataElement?.dataset.pautaSlug || "";
const casaLegislativa = pautaDataElement?.dataset.casaLegislativa || "";

// As vari√°veis de dados extras e evid√™ncias precisam ser carregadas
// (Idealmente via fetch para /_data/congressistas_extras.json e /_data/evidencias_pautas.json)
let congressistasExtras = { congressistas: {} }; // Inicializa vazio
let evidenciasPautas = { pautas: {} }; // Inicializa vazio

// As vari√°veis de campanha precisam ser carregadas
let campanhaEmail = {}; // Inicializa vazio
let campanhaWhatsApp = {}; // Inicializa vazio
let campanhaInstagram = {}; // Inicializa vazio

// Parlamentares - iniciar vazio e carregar do cache
let parlamentaresBase = [];

// Tracking
let trackingData = JSON.parse(
  localStorage.getItem("campanhas_tracking") || "{}"
);
if (!trackingData[pautaSlug]) {
  trackingData[pautaSlug] = { email: null, whatsapp: [], instagram: [] };
}

let assessorCount = 0;

// Inicializa√ß√£o
document.addEventListener("DOMContentLoaded", function () {
  console.log("üìä Iniciando pauta...");

  // Inserir √≠cones
  document
    .querySelectorAll(".copy-icon")
    .forEach((el) => (el.innerHTML = copyIcon));
  document
    .getElementById("icon-whatsapp")
    ?.insertAdjacentHTML("afterbegin", whatsappIcon);
  document
    .getElementById("icon-instagram")
    ?.insertAdjacentHTML("afterbegin", instagramIcon);
  document
    .getElementById("icon-whatsapp-2")
    ?.insertAdjacentHTML("afterbegin", whatsappIcon); // No modal
  document
    .getElementById("icon-instagram-2")
    ?.insertAdjacentHTML("afterbegin", instagramIcon); // No modal

  // Carregar dados necess√°rios (extras, evid√™ncias, campanha, parlamentares)
  // Usaremos fetch para garantir que funcione mesmo sem Jekyll
  carregarDadosNecessarios();
});

// Dentro de carregarDadosNecessarios no pauta.js

async function carregarDadosNecessarios() {
  try {
    // Carregar dados extras (NOVO ENDPOINT)
    const extrasRes = await fetch("/api/congressistas_extras.json"); // <-- MUDOU AQUI
    if (extrasRes.ok) congressistasExtras = await extrasRes.json();
    // Adiciona uma verifica√ß√£o extra, pois o JSON agora vem de `site.data` que pode ter a chave 'congressistas'
    if (congressistasExtras && congressistasExtras.congressistas) {
      congressistasExtras = congressistasExtras; // Mant√©m a estrutura { congressistas: {...} } se ela existir
    } else {
      // Se a estrutura vier direto, envolvemos para manter a consist√™ncia esperada
      congressistasExtras = { congressistas: congressistasExtras || {} };
    }

    // Carregar evid√™ncias (NOVO ENDPOINT)
    const evidenciasRes = await fetch("/api/evidencias_pautas.json"); // <-- MUDOU AQUI
    if (evidenciasRes.ok) evidenciasPautas = await evidenciasRes.json();
    // Adiciona uma verifica√ß√£o similar para evid√™ncias, caso venha com a chave 'pautas'
    if (evidenciasPautas && evidenciasPautas.pautas) {
      evidenciasPautas = evidenciasPautas; // Mant√©m a estrutura { pautas: {...} }
    } else {
      evidenciasPautas = { pautas: evidenciasPautas || {} };
    }

    // Carregar dados da campanha (do front matter - via data attribute)
    const campanhaDataEl = document.getElementById("pauta-campanha-data");
    // ... (resto do c√≥digo igual) ...

    // Carregar parlamentares (essencial - continua buscando o cache)
    await carregarParlamentaresComCache();
  } catch (error) {
    console.error("Erro ao carregar dados iniciais:", error);
    // ... (resto do c√≥digo igual) ...
  }
}

// Tentar carregar do cache antes de buscar APIs
async function carregarParlamentaresComCache() {
  console.log("üîÑ Verificando cache de parlamentares...");

  // 1. Tentar localStorage (cache de 7 dias)
  try {
    const cacheLocal = localStorage.getItem("parlamentares_cache_v1");
    if (cacheLocal) {
      const parsed = JSON.parse(cacheLocal);
      const idade = Date.now() - parsed.timestamp;
      const seteDias = 7 * 24 * 60 * 60 * 1000;

      if (idade < seteDias && parsed.data && parsed.data.length > 0) {
        console.log(
          "‚úÖ Usando cache local:",
          parsed.data.length,
          "parlamentares"
        );
        parlamentaresBase = parsed.data; // Usar a lista completa

        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      } else {
        console.log("‚è∞ Cache expirado ou vazio");
      }
    }
  } catch (e) {
    console.log("‚ö†Ô∏è Erro ao ler cache local:", e);
  }

  // 2. Tentar arquivo de cache do site
  try {
    const response = await fetch("/parlamentares_cache.json");
    if (response.ok) {
      const cacheData = await response.json();
      const parlamentares = cacheData.parlamentares;

      if (parlamentares && parlamentares.length > 0) {
        console.log(
          `‚úÖ Cache do site carregado: ${parlamentares.length} parlamentares`
        );
        parlamentaresBase = parlamentares; // Usar a lista completa

        // Salvar no localStorage
        localStorage.setItem(
          "parlamentares_cache_v1",
          JSON.stringify({
            data: parlamentares,
            timestamp: Date.now(),
          })
        );

        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      }
    }
  } catch (e) {
    console.log("‚ö†Ô∏è Arquivo de cache n√£o dispon√≠vel:", e);
  }

  // SEM CACHE:
  console.error(
    "‚ùå Nenhum cache v√°lido encontrado. O carregamento das APIs ao vivo foi removido."
  );

  const tbody = document.getElementById("tabela-parlamentares-corpo");
  if (tbody) {
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados. Tente recarregar a p√°gina.</td></tr>';
  }
}

// Fun√ß√£o chamada ap√≥s o carregamento (do cache)
function finalizarCarregamento() {
  // Agora que temos a lista completa, filtramos pela Casa
  parlamentaresBase = parlamentaresBase.filter((p) => {
    if (!casaLegislativa) return true; // Se n√£o especificado, mostra todos
    if (casaLegislativa.includes("C√¢mara") && p.casa === "C√¢mara") return true;
    if (casaLegislativa.includes("Senado") && p.casa === "Senado") return true;
    return false;
  });

  console.log(
    "‚úÖ Total de parlamentares (filtrados):",
    parlamentaresBase.length
  );

  carregarEstados();
  renderTabela();
  carregarContadores();
  mostrarTracking();
}

// Carregar estados no filtro (ATUALIZADO)
function carregarEstados() {
  if (parlamentaresBase.length === 0) return;

  const estados = [...new Set(parlamentaresBase.map((p) => p.uf))].sort();

  // Lista de todos os dropdowns de estado
  const selectsIds = [
    "filtro-estado",
    "filtro-campanha-estado-email",
    "filtro-campanha-estado-wa",
    "filtro-campanha-estado-ig",
  ];

  selectsIds.forEach((id) => {
    const select = document.getElementById(id);
    if (select) {
      // Manter a primeira op√ß√£o
      const primeiraOpcaoHTML =
        select.options[0]?.outerHTML ||
        '<option value="">Todos os Estados</option>'; // Fallback
      select.innerHTML = primeiraOpcaoHTML; // Limpa mantendo a primeira

      estados.forEach((uf) => {
        // Usar o mapa para mostrar o nome completo
        const nomeCompleto = mapEstados[uf] || uf;
        const option = new Option(`${uf} - ${nomeCompleto}`, uf);
        select.add(option);
      });
    }
  });
}

// Renderizar tabela
function renderTabela() {
  const tbody = document.getElementById("tabela-parlamentares-corpo");

  if (!tbody) return; // Prote√ß√£o

  if (parlamentaresBase.length === 0) {
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-center">Nenhum parlamentar encontrado para esta Casa.</td></tr>';
    return;
  }

  const termoNome = document.getElementById("filtro-nome").value.toLowerCase();
  const termoEstado = document.getElementById("filtro-estado").value;
  const termoPosicao = document.getElementById("filtro-posicao").value;

  const filtrados = parlamentaresBase.filter((p) => {
    const nomeMatch = p.nome.toLowerCase().includes(termoNome);
    const estadoMatch = !termoEstado || p.uf === termoEstado;
    const posicao = obterPosicao(p.id);
    const posicaoMatch = !termoPosicao || posicao === termoPosicao;
    return nomeMatch && estadoMatch && posicaoMatch;
  });

  if (filtrados.length === 0) {
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-center">Nenhum parlamentar encontrado com esses filtros.</td></tr>';
    return;
  }

  tbody.innerHTML = filtrados
    .map((p) => {
      const posicao = obterPosicao(p.id);
      const badgeClass =
        posicao === "apoia"
          ? "badge-apoia"
          : posicao === "contrario"
          ? "badge-contrario"
          : "badge-nao-manifestado"; // ATUALIZADO
      const statusTexto =
        posicao === "apoia"
          ? "Apoia"
          : posicao === "contrario"
          ? "Contr√°rio"
          : "N√£o se Manifestou"; // ATUALIZADO

      // Escapar nome para uso em JS
      const nomeEscapado = p.nome.replace(/'/g, "\\'").replace(/"/g, "&quot;");

      return `<tr>
      <td>${p.nome}</td>
      <td>${p.partido}</td>
      <td>${p.uf}</td>
      <td><span class="badge-status ${badgeClass}">${statusTexto}</span></td>
      <td>
        <button class="btn btn-sm btn-info" onclick='verContato(${JSON.stringify(
          p
        )})'>Ver Contato</button>
        <button class="btn btn-sm btn-warning" onclick="abrirEnviarInfo('${
          p.id
        }', '${nomeEscapado}')">Enviar Info</button>
      </td>
    </tr>`;
    })
    .join("");
}

// Obter posi√ß√£o (do YAML global ou local se key_player)
// SUBSTITUA A FUN√á√ÉO obterPosicao INTEIRA POR ESTA VERS√ÉO CORRIGIDA:

function obterPosicao(parlamentarId) {
  // 1. Tentar ler das evid√™ncias globais (prioridade maior para plen√°rio)
  //    Certifique-se que evidenciasPautas foi carregado corretamente
  if (
    evidenciasPautas &&
    evidenciasPautas.pautas &&
    evidenciasPautas.pautas[pautaSlug] &&
    evidenciasPautas.pautas[pautaSlug][parlamentarId]
  ) {
    return (
      evidenciasPautas.pautas[pautaSlug][parlamentarId].posicao ||
      "nao-manifestado"
    );
  }

  // 2. Tentar ler do 'key_players' da pauta (se n√£o encontrado globalmente)
  const keyPlayersDataEl = document.getElementById("pauta-keyplayers-data");
  if (keyPlayersDataEl) {
    try {
      // Parse potencialmente null data attribute mais safely
      const keyPlayersStr = keyPlayersDataEl.dataset.keyPlayers || "[]"; // Garante que seja pelo menos '[]'
      let keyPlayers = null;

      // Tenta o parse, mas evita erro se a string for inv√°lida ou "null"
      try {
        keyPlayers = JSON.parse(keyPlayersStr);
      } catch (parseError) {
        console.warn(
          "data-key-players n√£o √© JSON v√°lido:",
          keyPlayersStr,
          parseError
        );
        keyPlayers = []; // Trata como array vazio em caso de erro no parse
      }

      // Check if keyPlayers √© realmente um array antes de chamar .find
      if (Array.isArray(keyPlayers)) {
        // <-- CHECAGEM ESSENCIAL
        // Encontra o parlamentar na lista base ANTES de tentar ler key_players
        const parlamentarAtual = parlamentaresBase.find(
          (parl) => parl.id === parlamentarId
        );

        // Verifica se encontrou o parlamentarAtual ANTES de tentar ler .nome
        if (parlamentarAtual) {
          // <-- CHECAGEM ESSENCIAL
          const keyPlayer = keyPlayers.find(
            (p) => p.nome === parlamentarAtual.nome
          );
          if (keyPlayer && keyPlayer.position) {
            return keyPlayer.position; // Retorna a posi√ß√£o do key_player
          }
        } else {
          // console.warn(`Parlamentar com ID ${parlamentarId} n√£o encontrado em parlamentaresBase.`);
        }
      } else {
        // Isso pode acontecer se data-key-players for "null" ou algo inesperado
        console.warn("data-key-players n√£o resultou em um array:", keyPlayers);
      }
    } catch (e) {
      // Captura outros erros inesperados durante a leitura
      console.error("Erro inesperado ao ler key_players:", e);
    }
  } else {
    // console.warn("Elemento #pauta-keyplayers-data n√£o encontrado no DOM.");
  }

  // Se n√£o encontrou posi√ß√£o global nem local, retorna o padr√£o
  return "nao-manifestado";
}

// Filtros
document.getElementById("filtro-nome")?.addEventListener("input", renderTabela);
document
  .getElementById("filtro-estado")
  ?.addEventListener("change", renderTabela);
document
  .getElementById("filtro-posicao")
  ?.addEventListener("change", renderTabela);

// VER CONTATO (sem mudan√ßas significativas)
function verContato(parlamentar) {
  const extras = congressistasExtras.congressistas?.[parlamentar.id] || {};
  let html = "";
  // ... (resto do c√≥digo igual) ...
  // Necess√°rio carregar jQuery para $('#modalVerContato').modal('show');
}

// ENVIAR INFO (sem mudan√ßas significativas)
function abrirEnviarInfo(parlamentarId, nome) {
  document.getElementById("parlamentar-id-hidden").value = parlamentarId;
  document.getElementById("parlamentar-nome-hidden").value = nome;
  document.getElementById("enviar-info-nome").textContent = nome;
  document.getElementById("formEnviarInfo").reset();
  document.getElementById("assessores-lista").innerHTML = "";
  assessorCount = 0;
  // Necess√°rio carregar jQuery para $('#modalEnviarInfo').modal('show');
}
function adicionarAssessor() {
  /* ... */
}
document
  .getElementById("formEnviarInfo")
  ?.addEventListener("submit", async function (e) {
    e.preventDefault();
    // ... (resto do c√≥digo igual) ...
    // Necess√°rio carregar jQuery para $('#modalEnviarInfo').modal('hide');
  });

// CAMPANHAS - Contadores (sem mudan√ßas)
function carregarContadores() {
  /* ... */
}

// ==========================================
// FUN√á√ïES DE CAMPANHA (ATUALIZADAS)
// ==========================================

// NOVO: Fun√ß√£o auxiliar para gerar o prefixo
function gerarPrefixoMensagem(idSelectEstado, idInputNome) {
  const selectEstadoEl = document.getElementById(idSelectEstado);
  const inputNomeEl = document.getElementById(idInputNome);

  const estadoSelecionado = selectEstadoEl ? selectEstadoEl.value : null;
  const nomeUsuario = inputNomeEl ? inputNomeEl.value : null;

  let prefixo = "Sou Agente de Seguran√ßa Socioeducativo."; // Padr√£o

  if (estadoSelecionado) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo do Estado do ${nomeEstado}.`;
  }

  if (estadoSelecionado && nomeUsuario) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo do Estado do ${nomeEstado}, meu nome √© ${nomeUsuario}.`;
  } else if (nomeUsuario) {
    // Caso n√£o selecione estado mas coloque o nome
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo, meu nome √© ${nomeUsuario}.`;
  }

  return prefixo + "\n\n"; // Adiciona duas quebras de linha
}

// NOVO: Fun√ß√£o auxiliar para copiar
async function copiarParaClipboard(targetId, buttonEl) {
  const elemento = document.getElementById(targetId);
  let texto = elemento.value || elemento.textContent;

  if (!texto) return;

  try {
    await navigator.clipboard.writeText(texto);

    // Feedback visual
    const originalHtml = buttonEl.innerHTML; // Salva o SVG original
    buttonEl.innerHTML = "‚úÖ";
    buttonEl.style.color = "#28a745";
    buttonEl.title = "Copiado!"; // Atualiza o tooltip

    setTimeout(() => {
      buttonEl.innerHTML = originalHtml; // Restaura o SVG
      buttonEl.style.color = "#6c757d";
      // Restaura o title original (se precisar, pegue do HTML ou defina aqui)
      // Exemplo: buttonEl.title = 'Copiar lista de emails';
    }, 1500);
  } catch (err) {
    console.error("Falha ao copiar: ", err);
    alert("Falha ao copiar. Tente manualmente.");
  }
}

function abrirCampanhaEmail() {
  // Verifica se o objeto campanhaEmail existe e tem dados necess√°rios
  if (
    !campanhaEmail ||
    !campanhaEmail.assunto ||
    !campanhaEmail.mensagem_oposicao
  ) {
    return alert(
      "Campanha de email n√£o configurada corretamente para esta pauta (faltando assunto ou mensagem)."
    );
  }

  const selectEstado = document.getElementById("filtro-campanha-estado-email");
  const inputNome = document.getElementById("campo-nome-email");
  const textareaEmails = document.getElementById("emails-lista");
  const inputAssunto = document.getElementById("email-assunto");
  const textareaMensagem = document.getElementById("email-mensagem");
  const totalEmailsEl = document.getElementById("total-emails-campanha");

  // Templates de mensagem (da nova estrutura)
  const templateOposicao = campanhaEmail.mensagem_oposicao || "";
  // templateApoio n√£o √© usado aqui, pois a campanha de email foca em quem n√£o apoia
  const templateExtra = campanhaEmail.mensagem_extra || ""; // Pega o complemento

  // Fun√ß√£o interna para atualizar a lista e a mensagem
  function atualizarFiltroEmail() {
    const estadoSelecionado = selectEstado.value;

    // 1. Filtrar Parlamentares (foco em quem N√ÉO apoia)
    const parlamentaresFiltrados = parlamentaresBase.filter((p) => {
      const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
      if (!estadoMatch) return false;

      const posicao = obterPosicao(p.id);
      // Inclui contr√°rio E n√£o manifestado
      return posicao === "contrario" || posicao === "nao-manifestado";
    });

    // 2. Montar a lista de emails
    const emails = parlamentaresFiltrados
      .filter((p) => p.email)
      .map((p) => p.email);
    textareaEmails.value = emails.join("; ");
    totalEmailsEl.innerHTML = `Total: <strong>${emails.length}</strong> email(s) selecionado(s) (quem n√£o apoia)`; // Atualizado

    // 3. Montar a Mensagem
    const prefixo = gerarPrefixoMensagem(
      "filtro-campanha-estado-email",
      "campo-nome-email"
    );
    let mensagemFinal = prefixo + templateOposicao; // Come√ßa com prefixo + oposi√ß√£o

    // Adiciona o complemento, se existir
    if (templateExtra) {
      mensagemFinal += "\n\n---\n" + templateExtra; // Adiciona com separador
    }

    inputAssunto.value = campanhaEmail.assunto || "";
    textareaMensagem.value = mensagemFinal;
  }

  // 4. Adicionar "ouvintes" de mudan√ßa
  selectEstado.onchange = atualizarFiltroEmail;
  inputNome.oninput = atualizarFiltroEmail;

  // 5. Chamar a fun√ß√£o uma vez para carregar o estado inicial
  atualizarFiltroEmail();

  // 6. Abrir o modal (Necess√°rio jQuery)
  $("#modalCampanhaEmail").modal("show");
}

function abrirClienteEmail() {
  const emails = document.getElementById("emails-lista").value;
  const assunto = document.getElementById("email-assunto").value;
  const mensagem = document.getElementById("email-mensagem").value;

  const mailto = `mailto:?bcc=${encodeURIComponent(
    emails
  )}&subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(
    mensagem
  )}`;

  if (mailto.length > 2000) {
    alert("‚ö†Ô∏è Muitos emails! Use os √≠cones de copiar manualmente.");
    return;
  }

  window.location.href = mailto;

  trackingData[pautaSlug].email = new Date().toISOString();
  salvarTracking();
  mostrarTracking();
}

// ATUALIZADO: CAMPANHA WHATSAPP
function abrirCampanhaWhatsApp() {
  if (!campanhaWhatsApp) return alert("Campanha de WhatsApp n√£o configurada.");

  // Armazena os templates em textareas escondidos
  document.getElementById("whatsapp-mensagem-oposicao").value =
    campanhaWhatsApp.mensagem_oposicao || "";
  document.getElementById("whatsapp-mensagem-apoio").value =
    campanhaWhatsApp.mensagem_apoio || "";

  const selectEstado = document.getElementById("filtro-campanha-estado-wa");
  const inputNome = document.getElementById("campo-nome-wa");

  // Adicionar listeners para atualizar a lista
  selectEstado.onchange = atualizarListaWhatsApp;
  inputNome.oninput = atualizarListaWhatsApp; // Atualiza ao digitar nome tamb√©m (para prefixo)

  atualizarListaWhatsApp();
  // Necess√°rio jQuery para abrir modal
  $("#modalCampanhaWhatsApp").modal("show");
}

function atualizarListaWhatsApp() {
  const listaEl = document.getElementById("lista-whatsapp");
  const totalEl = document.getElementById("total-whatsapp");
  const estadoSelecionado = document.getElementById(
    "filtro-campanha-estado-wa"
  ).value;

  // --- L√≥gica de Texto Din√¢mico ---
  let cargo = "Parlamentares";
  if (casaLegislativa.includes("C√¢mara")) cargo = "Deputados(as)";
  else if (casaLegislativa.includes("Senado")) cargo = "Senadores(as)";
  let textoEstado = "de todos os estados";
  if (estadoSelecionado)
    textoEstado = `do Estado do ${
      mapEstados[estadoSelecionado] || estadoSelecionado
    }`;
  // --- Fim ---

  // Filtra parlamentares
  const parlamentares = parlamentaresBase.filter((p) => {
    const temWhatsApp = congressistasExtras.congressistas?.[p.id]?.whatsapp;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temWhatsApp && estadoMatch;
  });

  const count = parlamentares.length;

  if (count > 0) {
    totalEl.innerHTML = `Total: <strong>${count}</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
    const enviados = trackingData[pautaSlug].whatsapp || [];

    listaEl.innerHTML = parlamentares
      .map((p) => {
        /* ... (c√≥digo igual) ... */
      })
      .join("");
    parlamentares.forEach((p) => {
      /* ... (c√≥digo igual para √≠cones) ... */
    });
  } else {
    totalEl.innerHTML = `Total: <strong>0</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado}.`;
    listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">...</div>`; // (c√≥digo igual)
  }

  atualizarProgressoWhatsApp();
}

// SUBSTITUA A FUN√á√ÉO enviarWhatsApp em pauta.js

function enviarWhatsApp(parlamentarId) {
  // Verifica se o objeto campanhaWhatsApp existe e tem as mensagens
  if (
    !campanhaWhatsApp ||
    !campanhaWhatsApp.mensagem_oposicao ||
    !campanhaWhatsApp.mensagem_apoio
  ) {
    // Mostra um alerta gen√©rico ou pode buscar a mensagem de erro da campanha se existir
    return alert(
      "Campanha de WhatsApp n√£o configurada corretamente (mensagens faltando)."
    );
  }

  const parlamentar = parlamentaresBase.find((p) => p.id === parlamentarId);
  // Verifica se encontrou o parlamentar (importante)
  if (!parlamentar) {
    console.error(`Parlamentar com ID ${parlamentarId} n√£o encontrado.`);
    return alert("Erro: Parlamentar n√£o encontrado.");
  }

  const extras = congressistasExtras.congressistas[parlamentarId];
  // Verifica se h√° dados extras e WhatsApp (importante)
  if (!extras || !extras.whatsapp) {
    console.error(
      `Dados extras (WhatsApp) n√£o encontrados para ${parlamentar.nome} (ID: ${parlamentarId}).`
    );
    return alert(
      `Erro: N√∫mero de WhatsApp n√£o cadastrado para ${parlamentar.nome}. Contribua com a informa√ß√£o!`
    );
  }

  const posicao = obterPosicao(parlamentarId);

  // 1. Gerar prefixo
  const prefixo = gerarPrefixoMensagem(
    "filtro-campanha-estado-wa",
    "campo-nome-wa"
  );

  // 2. Escolher template (Oposi√ß√£o ou Agradecimento)
  const templateOposicao = campanhaWhatsApp.mensagem_oposicao || ""; // Usa fallback para string vazia
  const templateApoio = campanhaWhatsApp.mensagem_apoio || ""; // Usa fallback para string vazia

  let mensagemBase = templateOposicao; // Padr√£o
  if (posicao === "apoia" && templateApoio) {
    // S√≥ usa template de apoio se existir
    mensagemBase = templateApoio;
  }

  // 3. Montar mensagem final
  const mensagem = (prefixo + mensagemBase).replace(
    /\[NOME\]/g,
    parlamentar.nome
  );
  // [ESTADO] n√£o √© mais substitu√≠do automaticamente aqui

  // Pega o n√∫mero (pode ser string ou primeiro do array)
  let whatsapp = extras.whatsapp;
  if (Array.isArray(whatsapp)) whatsapp = whatsapp[0];
  if (!whatsapp) {
    // Verifica√ß√£o adicional
    return alert(`Erro: N√∫mero de WhatsApp inv√°lido para ${parlamentar.nome}.`);
  }

  const url = `https://wa.me/55${whatsapp.replace(
    /\D/g,
    ""
  )}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, "_blank");

  // Tracking...
  if (!trackingData[pautaSlug].whatsapp) trackingData[pautaSlug].whatsapp = [];
  if (!trackingData[pautaSlug].whatsapp.includes(parlamentarId)) {
    trackingData[pautaSlug].whatsapp.push(parlamentarId);
  }
  salvarTracking();
  atualizarListaWhatsApp(); // Re-renderiza a lista para mostrar o checkmark
  mostrarTracking();
}

function atualizarProgressoWhatsApp() {
  /* ... (c√≥digo igual) ... */
}

// ATUALIZADO: CAMPANHA INSTAGRAM
function abrirCampanhaInstagram() {
  if (!campanhaInstagram)
    return alert("Campanha de Instagram n√£o configurada.");

  document.getElementById("instagram-mensagem-oposicao").value =
    campanhaInstagram.mensagem_oposicao || "";
  document.getElementById("instagram-mensagem-apoio").value =
    campanhaInstagram.mensagem_apoio || "";

  const selectEstado = document.getElementById("filtro-campanha-estado-ig");
  const inputNome = document.getElementById("campo-nome-ig");

  selectEstado.onchange = atualizarListaInstagram;
  inputNome.oninput = atualizarListaInstagram; // Atualiza para prefixo

  atualizarListaInstagram();
  // Necess√°rio jQuery
  $("#modalCampanhaInstagram").modal("show");
}

function atualizarListaInstagram() {
  const listaEl = document.getElementById("lista-instagram");
  const totalEl = document.getElementById("total-instagram");
  const estadoSelecionado = document.getElementById(
    "filtro-campanha-estado-ig"
  ).value;

  // --- L√≥gica de Texto Din√¢mico ---
  let cargo = "Parlamentares";
  if (casaLegislativa.includes("C√¢mara")) cargo = "Deputados(as)";
  else if (casaLegislativa.includes("Senado")) cargo = "Senadores(as)";
  let textoEstado = "de todos os estados";
  if (estadoSelecionado)
    textoEstado = `do Estado do ${
      mapEstados[estadoSelecionado] || estadoSelecionado
    }`;
  // --- Fim ---

  // Filtra parlamentares
  const parlamentares = parlamentaresBase.filter((p) => {
    const temIg = congressistasExtras.congressistas?.[p.id]?.instagram;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temIg && estadoMatch;
  });

  const count = parlamentares.length;

  if (count > 0) {
    totalEl.innerHTML = `Total: <strong>${count}</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
    const enviados = trackingData[pautaSlug].instagram || [];

    listaEl.innerHTML = parlamentares
      .map((p) => {
        /* ... (c√≥digo igual) ... */
      })
      .join("");
    parlamentares.forEach((p) => {
      /* ... (c√≥digo igual para √≠cones) ... */
    });
  } else {
    totalEl.innerHTML = `Total: <strong>0</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado}.`;
    listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">...</div>`; // (c√≥digo igual)
  }

  atualizarProgressoInstagram();
}

// SUBSTITUA A FUN√á√ÉO enviarInstagram em pauta.js

function enviarInstagram(parlamentarId) {
  // Verifica se o objeto campanhaInstagram existe e tem as mensagens
  if (
    !campanhaInstagram ||
    !campanhaInstagram.mensagem_oposicao ||
    !campanhaInstagram.mensagem_apoio
  ) {
    return alert(
      "Campanha de Instagram n√£o configurada corretamente (mensagens faltando)."
    );
  }

  const parlamentar = parlamentaresBase.find((p) => p.id === parlamentarId);
  if (!parlamentar) {
    console.error(`Parlamentar com ID ${parlamentarId} n√£o encontrado.`);
    return alert("Erro: Parlamentar n√£o encontrado.");
  }

  const extras = congressistasExtras.congressistas[parlamentarId];
  // Verifica se h√° dados extras e Instagram
  if (!extras || !extras.instagram) {
    console.error(
      `Dados extras (Instagram) n√£o encontrados para ${parlamentar.nome} (ID: ${parlamentarId}).`
    );
    return alert(
      `Erro: Perfil do Instagram n√£o cadastrado para ${parlamentar.nome}. Contribua com a informa√ß√£o!`
    );
  }

  const posicao = obterPosicao(parlamentarId);

  // 1. Gerar prefixo
  const prefixo = gerarPrefixoMensagem(
    "filtro-campanha-estado-ig",
    "campo-nome-ig"
  );

  // 2. Escolher template
  const templateOposicao = campanhaInstagram.mensagem_oposicao || "";
  const templateApoio = campanhaInstagram.mensagem_apoio || "";

  let mensagemBase = templateOposicao; // Padr√£o
  if (posicao === "apoia" && templateApoio) {
    mensagemBase = templateApoio;
  }

  // 3. Montar mensagem final para copiar
  const mensagem = (prefixo + mensagemBase).replace(
    /\[NOME\]/g,
    parlamentar.nome
  );

  // 4. Abrir link do Direct
  const instagramUser = extras.instagram.replace("@", "");
  const url = `https://ig.me/m/${instagramUser}`;
  window.open(url, "_blank");

  // 5. Copiar mensagem e avisar
  navigator.clipboard
    .writeText(mensagem)
    .then(() => {
      alert(
        "A mensagem foi copiada. Cole-a no Direct do Instagram que acabou de abrir."
      );
    })
    .catch((err) => {
      console.error("Falha ao copiar mensagem do Instagram:", err);
      // Fallback: Mostrar a mensagem para o usu√°rio copiar manualmente
      prompt(
        "N√£o foi poss√≠vel copiar automaticamente. Copie a mensagem abaixo:",
        mensagem
      );
    });

  // Tracking...
  if (!trackingData[pautaSlug].instagram)
    trackingData[pautaSlug].instagram = [];
  if (!trackingData[pautaSlug].instagram.includes(parlamentarId)) {
    trackingData[pautaSlug].instagram.push(parlamentarId);
  }
  salvarTracking();
  atualizarListaInstagram(); // Re-renderiza a lista
  mostrarTracking();
}

function atualizarProgressoInstagram() {
  /* ... (c√≥digo igual) ... */
}

// TRACKING (sem mudan√ßas)
function salvarTracking() {
  /* ... */
}
function mostrarTracking() {
  /* ... */
}
function fecharTracking() {
  /* ... */
}
