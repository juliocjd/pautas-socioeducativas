// ==========================================
// √çCONES E MAPAS (NOVOS)
// ==========================================

const whatsappIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
</svg>`;

const instagramIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
</svg>`;

const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
  <path d="M13 0H6a2 2 0 0 0-2 2 2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 2 2 0 0 0 2-2V4a2 2 0 0 0-2-2 2 2 0 0 0-2-2zM2 4a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4z"/>
  <path d="M13.5 1a.5.5 0 0 0-.5.5V3h-2a.5.5 0 0 0 0 1h2v1.5a.5.5 0 0 0 1 0V4h1.5a.5.5 0 0 0 0-1H14V1.5a.5.5 0 0 0-.5-.5z"/>
</svg>`;

let parlamentaresAtuaisParaTabela = []; // Guarda a lista correta para os filtros

// NOVO: Mapa de Estados
const mapEstados = {
  AC: "Acre",
  AL: "Alagoas",
  AP: "Amap√°",
  AM: "Amazonas",
  BA: "Bahia",
  CE: "Cear√°",
  DF: "Distrito Federal",
  ES: "Esp√≠rito Santo",
  GO: "Goi√°s",
  MA: "Maranh√£o",
  MT: "Mato Grosso",
  MS: "Mato Grosso do Sul",
  MG: "Minas Gerais",
  PA: "Par√°",
  PB: "Para√≠ba",
  PR: "Paran√°",
  PE: "Pernambuco",
  PI: "Piau√≠",
  RJ: "Rio de Janeiro",
  RN: "Rio Grande do Norte",
  RS: "Rio Grande do Sul",
  RO: "Rond√¥nia",
  RR: "Roraima",
  SC: "Santa Catarina",
  SP: "S√£o Paulo",
  SE: "Sergipe",
  TO: "Tocantins",
};

// ==========================================
// DADOS GLOBAIS
// ==========================================
// As vari√°veis pautaSlug, casaLegislativa, etc., precisam ser definidas aqui.
// A forma mais f√°cil √© ler de atributos 'data-' no HTML
const pautaDataElement = document.getElementById("pauta-data");
const pautaSlug = pautaDataElement?.dataset.pautaSlug || "";
const casaLegislativa = pautaDataElement?.dataset.casaLegislativa || "";

// As vari√°veis de dados extras e evid√™ncias precisam ser carregadas
// (Idealmente via fetch para /_data/congressistas_extras.json e /_data/evidencias_pautas.json)
let congressistasExtras = { congressistas: {} }; // Inicializa vazio
let evidenciasPautas = { pautas: {} }; // Inicializa vazio

// As vari√°veis de campanha precisam ser carregadas
let campanhaEmail = {}; // Inicializa vazio
let campanhaWhatsApp = {}; // Inicializa vazio
let campanhaInstagram = {}; // Inicializa vazio

// Parlamentares - iniciar vazio e carregar do cache
let parlamentaresBase = [];

// Tracking
let trackingData = JSON.parse(
  localStorage.getItem("campanhas_tracking") || "{}"
);
if (!trackingData[pautaSlug]) {
  trackingData[pautaSlug] = { email: null, whatsapp: [], instagram: [] };
}

let assessorCount = 0;

// Inicializa√ß√£o
document.addEventListener("DOMContentLoaded", function () {
  console.log("üìä Iniciando pauta...");

  // Inserir √≠cones
  document
    .querySelectorAll(".copy-icon")
    .forEach((el) => (el.innerHTML = copyIcon));
  document
    .getElementById("icon-whatsapp")
    ?.insertAdjacentHTML("afterbegin", whatsappIcon);
  document
    .getElementById("icon-instagram")
    ?.insertAdjacentHTML("afterbegin", instagramIcon);
  document
    .getElementById("icon-whatsapp-2")
    ?.insertAdjacentHTML("afterbegin", whatsappIcon); // No modal
  document
    .getElementById("icon-instagram-2")
    ?.insertAdjacentHTML("afterbegin", instagramIcon); // No modal

  // Carregar dados necess√°rios (extras, evid√™ncias, campanha, parlamentares)
  // Usaremos fetch para garantir que funcione mesmo sem Jekyll
  carregarDadosNecessarios();
});

// Dentro de carregarDadosNecessarios no pauta.js

async function carregarDadosNecessarios() {
  try {
    // Carregar dados extras (NOVO ENDPOINT)
    const extrasRes = await fetch("/api/congressistas_extras.json"); // <-- MUDOU AQUI
    if (extrasRes.ok) congressistasExtras = await extrasRes.json();
    // Adiciona uma verifica√ß√£o extra, pois o JSON agora vem de `site.data` que pode ter a chave 'congressistas'
    if (congressistasExtras && congressistasExtras.congressistas) {
      congressistasExtras = congressistasExtras; // Mant√©m a estrutura { congressistas: {...} } se ela existir
    } else {
      // Se a estrutura vier direto, envolvemos para manter a consist√™ncia esperada
      congressistasExtras = { congressistas: congressistasExtras || {} };
    }

    // Carregar evid√™ncias (NOVO ENDPOINT)
    const evidenciasRes = await fetch("/api/evidencias_pautas.json"); // <-- MUDOU AQUI
    if (evidenciasRes.ok) evidenciasPautas = await evidenciasRes.json();
    // Adiciona uma verifica√ß√£o similar para evid√™ncias, caso venha com a chave 'pautas'
    if (evidenciasPautas && evidenciasPautas.pautas) {
      evidenciasPautas = evidenciasPautas; // Mant√©m a estrutura { pautas: {...} }
    } else {
      evidenciasPautas = { pautas: evidenciasPautas || {} };
    }

    // Carregar dados da campanha (do front matter - via data attribute)
    const campanhaDataEl = document.getElementById("pauta-campanha-data");
    // ... (resto do c√≥digo igual) ...

    // Carregar parlamentares (essencial - continua buscando o cache)
    await carregarParlamentaresComCache();
  } catch (error) {
    console.error("Erro ao carregar dados iniciais:", error);
    // ... (resto do c√≥digo igual) ...
  }
}

// Tentar carregar do cache antes de buscar APIs
async function carregarParlamentaresComCache() {
  console.log("üîÑ Verificando cache de parlamentares...");

  // 1. Tentar localStorage (cache de 7 dias)
  try {
    const cacheLocal = localStorage.getItem("parlamentares_cache_v1");
    if (cacheLocal) {
      const parsed = JSON.parse(cacheLocal);
      const idade = Date.now() - parsed.timestamp;
      const seteDias = 7 * 24 * 60 * 60 * 1000;

      if (idade < seteDias && parsed.data && parsed.data.length > 0) {
        console.log(
          "‚úÖ Usando cache local:",
          parsed.data.length,
          "parlamentares"
        );
        parlamentaresBase = parsed.data; // Usar a lista completa

        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      } else {
        console.log("‚è∞ Cache expirado ou vazio");
      }
    }
  } catch (e) {
    console.log("‚ö†Ô∏è Erro ao ler cache local:", e);
  }

  // 2. Tentar arquivo de cache do site
  try {
    const response = await fetch("/parlamentares_cache.json");
    if (response.ok) {
      const cacheData = await response.json();
      const parlamentares = cacheData.parlamentares;

      if (parlamentares && parlamentares.length > 0) {
        console.log(
          `‚úÖ Cache do site carregado: ${parlamentares.length} parlamentares`
        );
        parlamentaresBase = parlamentares; // Usar a lista completa

        // Salvar no localStorage
        localStorage.setItem(
          "parlamentares_cache_v1",
          JSON.stringify({
            data: parlamentares,
            timestamp: Date.now(),
          })
        );

        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      }
    }
  } catch (e) {
    console.log("‚ö†Ô∏è Arquivo de cache n√£o dispon√≠vel:", e);
  }

  // SEM CACHE:
  console.error(
    "‚ùå Nenhum cache v√°lido encontrado. O carregamento das APIs ao vivo foi removido."
  );

  const tbody = document.getElementById("tabela-parlamentares-corpo");
  if (tbody) {
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados. Tente recarregar a p√°gina.</td></tr>';
  }
}

// Fun√ß√£o chamada ap√≥s o carregamento (do cache)
function finalizarCarregamento() {
  // Dados da pauta (lidos dos data attributes)
  const isPlenaryVote = pautaDataElement?.dataset.isPlenaryVote === "true";
  let keyPlayers = [];
  try {
    const keyPlayersStr =
      document.getElementById("pauta-keyplayers-data")?.dataset.keyPlayers ||
      "[]";
    const parsedKP = JSON.parse(keyPlayersStr);
    if (Array.isArray(parsedKP)) {
      keyPlayers = parsedKP;
    }
  } catch (e) {
    console.error("Erro ao parsear key_players em finalizarCarregamento", e);
  }

  // <<< IN√çCIO DA CORRE√á√ÉO DO BUG 5 >>>
  // Carregar dados da campanha que foram "queimados" no HTML
  try {
    const campanhaDataEl = document.getElementById("pauta-campanha-data");
    if (campanhaDataEl) {
      // Parseia o JSON que o Jekyll/Liquid gerou
      campanhaEmail = JSON.parse(campanhaDataEl.dataset.campanhaEmail || "{}");
      campanhaWhatsApp = JSON.parse(
        campanhaDataEl.dataset.campanhaWhatsapp || "{}"
      );
      campanhaInstagram = JSON.parse(
        campanhaDataEl.dataset.campanhaInstagram || "{}"
      );
      console.log("‚úÖ Dados da campanha carregados do DOM.");
    } else {
      console.warn("Elemento #pauta-campanha-data n√£o encontrado.");
    }
  } catch (e) {
    console.error("Erro ao parsear JSON dos dados da campanha:", e);
    // Garante que as vari√°veis permane√ßam como objetos vazios em caso de erro
    campanhaEmail = {};
    campanhaWhatsApp = {};
    campanhaInstagram = {};
  }
  // <<< FIM DA CORRE√á√ÉO DO BUG 5 >>>

  let parlamentaresParaExibir = [];

  if (isPlenaryVote) {
    // Vota√ß√£o em Plen√°rio: Filtra o cache pela casa
    console.log(
      `üèõÔ∏è Pauta de Plen√°rio. Filtrando ${parlamentaresBase.length} pela casa: ${casaLegislativa}`
    );
    parlamentaresParaExibir = parlamentaresBase.filter((p) => {
      if (!casaLegislativa) return true;
      if (casaLegislativa.includes("C√¢mara") && p.casa === "C√¢mara")
        return true;
      if (casaLegislativa.includes("Senado") && p.casa === "Senado")
        return true;
      return false;
    });
    console.log(`Filtrados para plen√°rio: ${parlamentaresParaExibir.length}`);
  } else if (keyPlayers.length > 0) {
    // N√£o √© Plen√°rio E TEM Key Players: Filtra o cache pelos nomes dos key players
    console.log(
      `üîë Pauta com ${keyPlayers.length} Membros-Chave. Buscando no cache...`
    );
    const keyPlayerNames = keyPlayers.map((kp) => kp.nome);
    parlamentaresParaExibir = parlamentaresBase.filter((p) =>
      keyPlayerNames.includes(p.nome)
    );
    console.log(`Encontrados no cache: ${parlamentaresParaExibir.length}`);
  } else {
    // N√£o √© Plen√°rio e N√ÉO TEM Key Players: Lista vazia
    console.log(
      "‚ÑπÔ∏è Pauta sem vota√ß√£o em plen√°rio e sem membros-chave definidos."
    );
    parlamentaresParaExibir = [];
  }

  // Atualiza a vari√°vel global
  parlamentaresAtuaisParaTabela = parlamentaresParaExibir;

  console.log(
    `‚úÖ Total de parlamentares para exibir na tabela: ${parlamentaresAtuaisParaTabela.length}`
  );

  carregarEstados(parlamentaresAtuaisParaTabela);
  renderTabela(parlamentaresAtuaisParaTabela);
  carregarContadores(parlamentaresAtuaisParaTabela);
  mostrarTracking();
}

// Carregar estados no filtro (ATUALIZADO)
// Modifique carregarEstados para aceitar a lista
function carregarEstados(listaParlamentares) {
  // Adiciona par√¢metro
  if (!listaParlamentares || listaParlamentares.length === 0) return;
  const estados = [...new Set(listaParlamentares.map((p) => p.uf))].sort(); // Usa o par√¢metro

  // ... (resto da fun√ß√£o igual) ...
  const selectsIds = [
    "filtro-estado",
    "filtro-campanha-estado-email",
    "filtro-campanha-estado-wa",
    "filtro-campanha-estado-ig",
  ];
  selectsIds.forEach((id) => {
    const select = document.getElementById(id);
    if (select) {
      const primeiraOpcaoHTML =
        select.options[0]?.outerHTML ||
        '<option value="">Todos os Estados</option>';
      select.innerHTML = primeiraOpcaoHTML;
      estados.forEach((uf) => {
        const nomeCompleto = mapEstados[uf] || uf;
        const option = new Option(`${uf} - ${nomeCompleto}`, uf);
        select.add(option);
      });
    }
  });
}

// Renderizar tabela (Responsiva + Destaque de Fun√ß√£o com BADGE)
function renderTabela(listaParlamentares) {
  const tbody = document.getElementById("tabela-parlamentares-corpo");
  if (!tbody) return;

  if (!listaParlamentares || listaParlamentares.length === 0) {
    tbody.innerHTML =
      '<tr><td colspan="6" class="text-center">Nenhum parlamentar a ser exibido para esta pauta.</td>'; // Colspan 6
    return;
  }

  const termoNome = document.getElementById("filtro-nome").value.toLowerCase();
  const termoEstado = document.getElementById("filtro-estado").value;
  const termoPosicao = document.getElementById("filtro-posicao").value;

  const filtrados = listaParlamentares.filter((p) => {
    const nomeMatch = p.nome.toLowerCase().includes(termoNome);
    const estadoMatch = !termoEstado || p.uf === termoEstado;
    const posicao = obterPosicao(p.id);
    const posicaoMatch = !termoPosicao || posicao === termoPosicao;
    return nomeMatch && estadoMatch && posicaoMatch;
  });

  if (filtrados.length === 0) {
    tbody.innerHTML =
      '<tr><td colspan="6" class="text-center">Nenhum parlamentar encontrado com esses filtros.</td></tr>'; // Colspan 6
    return;
  }

  tbody.innerHTML = filtrados
    .map((p) => {
      const posicao = obterPosicao(p.id);
      const funcao = obterFuncao(p.id);

      // --- L√ìGICA DE DESTAQUE ATUALIZADA ---
      let funcaoClass = "";
      const funcaoLower = funcao.toLowerCase();
      if (
        funcaoLower.includes("relator") ||
        funcaoLower.includes("presidente")
      ) {
        funcaoClass = "funcao-destaque"; // Classe de modifica√ß√£o
      }

      // Cria o HTML do badge (se a fun√ß√£o existir)
      const funcaoDisplayHTML = funcao
        ? `<span class="funcao-badge ${funcaoClass}">${funcao}</span>`
        : ""; // Se n√£o houver fun√ß√£o, c√©lula/div fica vazio
      // --- FIM DA L√ìGICA ---

      const badgeClass =
        posicao === "apoia"
          ? "badge-apoia"
          : posicao === "contrario"
          ? "badge-contrario"
          : "badge-nao-manifestado";
      const statusTexto =
        posicao === "apoia"
          ? "Apoia"
          : posicao === "contrario"
          ? "Contr√°rio"
          : "N√£o se Manifestou";
      const nomeEscapado = p.nome.replace(/'/g, "\\'").replace(/"/g, "&quot;");
      const parlamentarJsonString = JSON.stringify(p).replace(/'/g, "&apos;");

      return `<tr>
          <td>
            <strong>${p.nome}</strong>
            <div class="d-block d-md-none text-muted" style="margin-top: 4px;">
              ${funcaoDisplayHTML} <small class="d-block" style="margin-top: 4px;">${p.partido}-${p.uf}</small>
            </div>
          </td>
          
          <td class="d-none d-md-table-cell">${p.partido}</td>
          <td class="d-none d-md-table-cell">${p.uf}</td>
          <td class="d-none d-md-table-cell">${funcaoDisplayHTML}</td> <td><span class="badge-status ${badgeClass}">${statusTexto}</span></td>
          <td>
            <button class="btn btn-sm btn-info" onclick='verContato(${parlamentarJsonString})'>Ver Contato</button>
            <button class="btn btn-sm btn-warning" onclick="abrirEnviarInfo('${p.id}', '${nomeEscapado}')">Enviar Info</button>
          </td>
        </tr>`;
    })
    .join("");
}

// Obter posi√ß√£o (do YAML global ou local se key_player)
// SUBSTITUA A FUN√á√ÉO obterPosicao INTEIRA POR ESTA VERS√ÉO CORRIGIDA:

function obterPosicao(parlamentarId) {
  // 1. Tentar ler das evid√™ncias globais (prioridade maior para plen√°rio)
  //    Certifique-se que evidenciasPautas foi carregado corretamente
  if (
    evidenciasPautas &&
    evidenciasPautas.pautas &&
    evidenciasPautas.pautas[pautaSlug] &&
    evidenciasPautas.pautas[pautaSlug][parlamentarId]
  ) {
    return (
      evidenciasPautas.pautas[pautaSlug][parlamentarId].posicao ||
      "nao-manifestado"
    );
  }

  // 2. Tentar ler do 'key_players' da pauta (se n√£o encontrado globalmente)
  const keyPlayersDataEl = document.getElementById("pauta-keyplayers-data");
  if (keyPlayersDataEl) {
    try {
      // Parse potencialmente null data attribute mais safely
      const keyPlayersStr = keyPlayersDataEl.dataset.keyPlayers || "[]"; // Garante que seja pelo menos '[]'
      let keyPlayers = null;

      // Tenta o parse, mas evita erro se a string for inv√°lida ou "null"
      try {
        keyPlayers = JSON.parse(keyPlayersStr);
      } catch (parseError) {
        console.warn(
          "data-key-players n√£o √© JSON v√°lido:",
          keyPlayersStr,
          parseError
        );
        keyPlayers = []; // Trata como array vazio em caso de erro no parse
      }

      // Check if keyPlayers √© realmente um array antes de chamar .find
      if (Array.isArray(keyPlayers)) {
        // <-- CHECAGEM ESSENCIAL
        // Encontra o parlamentar na lista base ANTES de tentar ler key_players
        const parlamentarAtual = parlamentaresBase.find(
          (parl) => parl.id === parlamentarId
        );

        // Verifica se encontrou o parlamentarAtual ANTES de tentar ler .nome
        if (parlamentarAtual) {
          // <-- CHECAGEM ESSENCIAL
          const keyPlayer = keyPlayers.find(
            (p) => p.nome === parlamentarAtual.nome
          );
          if (keyPlayer && keyPlayer.position) {
            return keyPlayer.position; // Retorna a posi√ß√£o do key_player
          }
        } else {
          // console.warn(`Parlamentar com ID ${parlamentarId} n√£o encontrado em parlamentaresBase.`);
        }
      } else {
        // Isso pode acontecer se data-key-players for "null" ou algo inesperado
        console.warn("data-key-players n√£o resultou em um array:", keyPlayers);
      }
    } catch (e) {
      // Captura outros erros inesperados durante a leitura
      console.error("Erro inesperado ao ler key_players:", e);
    }
  } else {
    // console.warn("Elemento #pauta-keyplayers-data n√£o encontrado no DOM.");
  }

  // Se n√£o encontrou posi√ß√£o global nem local, retorna o padr√£o
  return "nao-manifestado";
}

// ==========================================
// INSERIR ESTE BLOCO DE C√ìDIGO
// (Logo ap√≥s a fun√ß√£o obterPosicao)
// ==========================================

// NOVA FUN√á√ÉO: Obter a Fun√ß√£o (role) do key_player
function obterFuncao(parlamentarId) {
  // Tenta ler do 'key_players' da pauta
  const keyPlayersDataEl = document.getElementById("pauta-keyplayers-data");
  if (keyPlayersDataEl) {
    try {
      const keyPlayersStr = keyPlayersDataEl.dataset.keyPlayers || "[]";
      let keyPlayers = null;

      try {
        // O HTML 'escapa' as aspas (ex: &quot;), precisamos de as reverter
        const unescapedStr = keyPlayersStr
          .replace(/&quot;/g, '"')
          .replace(/&apos;/g, "'");
        keyPlayers = JSON.parse(unescapedStr);
      } catch (parseError) {
        console.warn(
          "data-key-players parsing error:",
          parseError,
          keyPlayersStr
        );
        keyPlayers = []; // Trata como array vazio em caso de erro
      }

      if (Array.isArray(keyPlayers)) {
        // parlamentaresBase √© a lista completa carregada no in√≠cio
        const parlamentarAtual = parlamentaresBase.find(
          (parl) => parl.id === parlamentarId
        );

        if (parlamentarAtual) {
          // Encontra o key_player pelo NOME (como est√° guardado no YAML)
          const keyPlayer = keyPlayers.find(
            (p) => p.nome === parlamentarAtual.nome
          );
          // Retorna a 'role' (Fun√ß√£o) se existir
          if (keyPlayer && keyPlayer.role) {
            return keyPlayer.role;
          }
        }
      }
    } catch (e) {
      console.error("Erro inesperado ao ler key_players (obterFuncao):", e);
    }
  }
  return ""; // Padr√£o √© uma string vazia
}

// Filtros
document.getElementById("filtro-nome")?.addEventListener("input", renderTabela);
document
  .getElementById("filtro-estado")
  ?.addEventListener("change", renderTabela);
document
  .getElementById("filtro-posicao")
  ?.addEventListener("change", renderTabela);

// VER CONTATO - VERS√ÉO COMPLETA E CORRIGIDA
function verContato(parlamentar) {
  const extras = congressistasExtras.congressistas?.[parlamentar.id] || {};

  let html = "";

  // DADOS OFICIAIS (das APIs)
  html +=
    '<div class="alert alert-info" style="font-size: 0.9em; padding: 0.75rem 1.25rem;"><strong>üìã Dados Oficiais (API ' +
    parlamentar.casa +
    ")</strong></div>";

  if (parlamentar.email) {
    html += `<div class="contato-info">
      <div class="contato-info-titulo">üìß Email Oficial</div>
      <div class="contato-info-valor">${parlamentar.email}</div>
      <div class="contato-fonte">Fonte: API da ${parlamentar.casa}</div>
    </div>`;
  }

  // O telefone do gabinete vem do cache (atualizar-parlamentares.py)
  if (parlamentar.telefone_gabinete) {
    html += `<div class="contato-info">
      <div class="contato-info-titulo">üìû Telefone do Gabinete</div>
      <div class="contato-info-valor">${parlamentar.telefone_gabinete}</div>
      <div class="contato-fonte">Fonte: API da ${parlamentar.casa}</div>
    </div>`;
  }

  // DADOS DA COMUNIDADE (contribui√ß√µes aprovadas)
  if (
    extras.whatsapp ||
    extras.instagram ||
    (extras.assessores && extras.assessores.length > 0) ||
    extras.telefone_gabinete
  ) {
    html +=
      '<div class="alert alert-success mt-3" style="font-size: 0.9em; padding: 0.75rem 1.25rem;"><strong>üì± Dados da Comunidade (Contribui√ß√µes Aprovadas)</strong></div>';

    // CORRE√á√ÉO: WhatsApp pode ser string ou array
    if (extras.whatsapp) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo">${whatsappIcon} WhatsApp Pessoal</div>`;

      const whatsappList = Array.isArray(extras.whatsapp)
        ? extras.whatsapp
        : [extras.whatsapp];

      whatsappList.forEach((numero, index) => {
        html += `<a href="https://wa.me/55${numero.replace(
          /\D/g,
          ""
        )}" target="_blank" class="btn-acao-contato btn-whatsapp" style="margin: 5px 5px 5px 0;">
          ${whatsappIcon} ${
          whatsappList.length > 1 ? `WhatsApp ${index + 1}` : "Enviar WhatsApp"
        }
        </a>`;
      });

      html += `<div class="contato-fonte">Contribu√≠do pela comunidade</div>
      </div>`;
    }

    if (extras.instagram) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo">${instagramIcon} Instagram</div>
        <a href="https://instagram.com/${extras.instagram.replace(
          "@",
          ""
        )}" target="_blank" class="btn-acao-contato btn-instagram">
          ${instagramIcon} @${extras.instagram.replace("@", "")}
        </a>
        <div class="contato-fonte">Contribu√≠do pela comunidade</div>
      </div>`;
    }

    // Telefone de gabinete vindo da comunidade (se houver)
    if (extras.telefone_gabinete && !parlamentar.telefone_gabinete) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo">üìû Telefone do Gabinete (Comunidade)</div>
        <div class="contato-info-valor">${extras.telefone_gabinete}</div>
        <div class="contato-fonte">Contribu√≠do pela comunidade</div>
      </div>`;
    }

    if (extras.assessores && extras.assessores.length > 0) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo">üë• Assessores</div>
        <div class="assessores-lista">`;

      extras.assessores.forEach((ass) => {
        html += `<div class="assessor-item">
          <strong>${ass.nome}</strong> - ${ass.cargo || "Assessor(a)"}<br>
          <a href="https://wa.me/55${ass.whatsapp.replace(
            /\D/g,
            ""
          )}" target="_blank" class="btn-acao-contato btn-whatsapp btn-sm mt-2">
            ${whatsappIcon} Contatar
          </a>
        </div>`;
      });

      html += `</div>
        <div class="contato-fonte">Contribu√≠do pela comunidade</div>
      </div>`;
    }

    if (extras.ultima_atualizacao) {
      html += `<small class="text-muted">‚ÑπÔ∏è √öltima atualiza√ß√£o: ${extras.ultima_atualizacao}</small>`;
    }
  } else {
    html += `<div class="alert alert-warning mt-3">
      ‚ö†Ô∏è Nenhum dado adicional da comunidade dispon√≠vel.
      <br><button class="btn btn-sm btn-primary mt-2" onclick="$('#modalVerContato').modal('hide'); abrirEnviarInfo('${
        parlamentar.id
      }', '${parlamentar.nome.replace(/'/g, "\\'")}')">
        Contribuir com Informa√ß√µes
      </button>
    </div>`;
  }

  document.getElementById("contato-nome").textContent = parlamentar.nome;
  document.getElementById("contato-conteudo").innerHTML = html;
  // A LINHA FALTANTE:
  $("#modalVerContato").modal("show");
}

// ENVIAR INFO - VERS√ÉO COMPLETA E ATUALIZADA PARA CORRE√á√ïES
function abrirEnviarInfo(parlamentarId, nome) {
  // Limpar formul√°rio e campos ocultos
  document.getElementById("formEnviarInfo").reset();
  document.getElementById("parlamentar-id-hidden").value = parlamentarId;
  document.getElementById("parlamentar-nome-hidden").value = nome;
  document.getElementById("enviar-info-nome").textContent = nome;
  const assessoresLista = document.getElementById("assessores-lista");
  if (assessoresLista) assessoresLista.innerHTML = "";
  assessorCount = 0;

  // Elementos dos campos de exibi√ß√£o/corre√ß√£o
  const instagramAtualEl = document.getElementById("instagram_atual");
  const instagramInputEl = document.getElementById("campo-instagram");
  const instagramCorrecaoDiv = document.getElementById(
    "instagram_correcao_div"
  );
  const instagramCorrecaoCheck = document.getElementById(
    "corrigir_instagram_check"
  );
  const instagramCorrecaoValor = document.getElementById(
    "corrigir_instagram_valor"
  );

  const whatsappAtualListaEl = document.getElementById("whatsapp_atual_lista");
  const whatsappCorrecaoDiv = document.getElementById("whatsapp_correcao_div");
  const whatsappCorrecaoCheck = document.getElementById(
    "corrigir_whatsapp_check"
  );
  const whatsappCorrecaoObs = document.getElementById("corrigir_whatsapp_obs");

  const assessoresAtualListaEl = document.getElementById(
    "assessores_atual_lista"
  );
  const assessoresCorrecaoDiv = document.getElementById(
    "assessores_correcao_div"
  );
  const assessoresCorrecaoCheck = document.getElementById(
    "corrigir_assessores_check"
  );
  const assessoresCorrecaoObs = document.getElementById(
    "corrigir_assessores_obs"
  );

  // Resetar campos de corre√ß√£o
  if (instagramCorrecaoCheck) instagramCorrecaoCheck.checked = false;
  if (instagramCorrecaoValor) instagramCorrecaoValor.style.display = "none";
  if (whatsappCorrecaoCheck) whatsappCorrecaoCheck.checked = false;
  if (whatsappCorrecaoObs) whatsappCorrecaoObs.style.display = "none";
  if (assessoresCorrecaoCheck) assessoresCorrecaoCheck.checked = false;
  if (assessoresCorrecaoObs) assessoresCorrecaoObs.style.display = "none";

  // Buscar dados extras existentes
  const extras = congressistasExtras.congressistas?.[parlamentarId] || {};

  // L√≥gica do Instagram
  if (extras.instagram) {
    if (instagramAtualEl) {
      instagramAtualEl.textContent = `@${extras.instagram}`;
      instagramAtualEl.style.display = "block";
    }
    if (instagramInputEl) instagramInputEl.style.display = "none"; // Esconde input de adicionar
    if (instagramCorrecaoDiv) instagramCorrecaoDiv.style.display = "block"; // Mostra op√ß√£o de corrigir
  } else {
    if (instagramAtualEl) instagramAtualEl.style.display = "none";
    if (instagramInputEl) instagramInputEl.style.display = "block"; // Mostra input de adicionar
    if (instagramCorrecaoDiv) instagramCorrecaoDiv.style.display = "none";
  }

  // L√≥gica do WhatsApp
  const whatsappExistente = Array.isArray(extras.whatsapp)
    ? extras.whatsapp
    : extras.whatsapp
    ? [extras.whatsapp]
    : [];
  if (whatsappExistente.length > 0) {
    if (whatsappAtualListaEl) {
      whatsappAtualListaEl.innerHTML = whatsappExistente
        .map((num) => `<div>- ${num}</div>`)
        .join("");
      whatsappAtualListaEl.classList.remove("text-muted"); // Remove 'Nenhum cadastrado'
    }
    if (whatsappCorrecaoDiv) whatsappCorrecaoDiv.style.display = "block"; // Mostra op√ß√£o de corrigir
  } else {
    if (whatsappAtualListaEl) {
      whatsappAtualListaEl.innerHTML = "Nenhum cadastrado.";
      whatsappAtualListaEl.classList.add("text-muted");
    }
    if (whatsappCorrecaoDiv) whatsappCorrecaoDiv.style.display = "none";
  }
  // Input para adicionar novo WhatsApp fica sempre vis√≠vel

  // L√≥gica dos Assessores
  const assessoresExistente = extras.assessores || [];
  if (assessoresExistente.length > 0) {
    if (assessoresAtualListaEl) {
      assessoresAtualListaEl.innerHTML = assessoresExistente
        .map(
          (ass) =>
            `<div class="mb-1 p-1 border rounded bg-light small">
                 <strong>${ass.nome}</strong> (${
              ass.cargo || "Assessor(a)"
            })<br>
                 <small>WhatsApp: ${ass.whatsapp}</small>
               </div>`
        )
        .join("");
    }
    if (assessoresCorrecaoDiv) assessoresCorrecaoDiv.style.display = "block"; // Mostra op√ß√£o de corrigir
  } else {
    if (assessoresAtualListaEl)
      assessoresAtualListaEl.innerHTML = "Nenhum cadastrado.";
    if (assessoresCorrecaoDiv) assessoresCorrecaoDiv.style.display = "none";
  }
  // Bot√£o para adicionar novo assessor fica sempre vis√≠vel

  // Adicionar listeners aos checkboxes de corre√ß√£o
  if (instagramCorrecaoCheck && instagramCorrecaoValor) {
    instagramCorrecaoCheck.onchange = () => {
      instagramCorrecaoValor.style.display = instagramCorrecaoCheck.checked
        ? "block"
        : "none";
    };
  }
  if (whatsappCorrecaoCheck && whatsappCorrecaoObs) {
    whatsappCorrecaoCheck.onchange = () => {
      whatsappCorrecaoObs.style.display = whatsappCorrecaoCheck.checked
        ? "block"
        : "none";
    };
  }
  if (assessoresCorrecaoCheck && assessoresCorrecaoObs) {
    assessoresCorrecaoCheck.onchange = () => {
      assessoresCorrecaoObs.style.display = assessoresCorrecaoCheck.checked
        ? "block"
        : "none";
    };
  }

  // Abrir o modal
  $("#modalEnviarInfo").modal("show");
}

function adicionarAssessor() {
  assessorCount++;
  const html = `<div class="assessor-item mb-2" id="assessor-${assessorCount}" style="background: #fdfdfd; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;">
    <div class="row">
      <div class="col-md-5">
        <input type="text" class="form-control form-control-sm" placeholder="Nome do Assessor" data-field="nome" required>
      </div>
      <div class="col-md-4">
        <input type="text" class="form-control form-control-sm" placeholder="WhatsApp (somente n√∫meros)" data-field="whatsapp" required>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control form-control-sm" placeholder="Cargo (opcional)" data-field="cargo">
      </div>
    </div>
    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById('assessor-${assessorCount}').remove()">Remover Assessor</button>
  </div>`;

  const lista = document.getElementById("assessores-lista");
  if (lista) {
    lista.insertAdjacentHTML("beforeend", html);
  }
}

// Submit formul√°rio
// Submit formul√°rio Enviar Info - ATUALIZADO PARA CORRE√á√ïES
document
  .getElementById("formEnviarInfo")
  ?.addEventListener("submit", async function (e) {
    e.preventDefault();

    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

    const parlamentarId = document.getElementById(
      "parlamentar-id-hidden"
    ).value;
    const parlamentarNome = document.getElementById(
      "parlamentar-nome-hidden"
    ).value;

    // --- Coletar NOVOS dados ---
    const dados_contato = {};
    const whatsappInput = document.getElementById("campo-whatsapp");
    const instagramInput = document.getElementById("campo-instagram"); // Pode estar escondido
    const instagramAtualEl = document.getElementById("instagram_atual"); // Pega o span

    // S√≥ adiciona whatsapp se o campo for preenchido
    if (whatsappInput && whatsappInput.value) {
      dados_contato.whatsapp = whatsappInput.value.replace(/\D/g, ""); // Limpa
    }
    // S√≥ adiciona instagram se o input estiver vis√≠vel e preenchido
    if (
      instagramInput &&
      instagramInput.style.display !== "none" &&
      instagramInput.value
    ) {
      dados_contato.instagram = instagramInput.value.replace("@", ""); // Limpa
    }

    const assessores = [];
    document
      .querySelectorAll("#assessores-lista .assessor-item")
      .forEach((item) => {
        const nome = item.querySelector('[data-field="nome"]').value;
        const whatsapp = item
          .querySelector('[data-field="whatsapp"]')
          .value.replace(/\D/g, ""); // Limpa
        const cargo = item.querySelector('[data-field="cargo"]').value;
        if (nome && whatsapp) {
          assessores.push({
            nome,
            whatsapp: whatsapp,
            cargo: cargo || "Assessor(a)",
          });
        }
      });
    if (assessores.length > 0) {
      dados_contato.assessores = assessores;
    }

    // --- Coletar Evid√™ncia (igual) ---
    let evidencia = null;
    const evidenciaUrl = document.getElementById("campo-evidencia-url").value;
    if (evidenciaUrl) {
      evidencia = {
        tipo: document.getElementById("campo-evidencia-tipo").value,
        url: evidenciaUrl,
        descricao: document.getElementById("campo-evidencia-desc").value,
      };
    }

    // --- IN√çCIO DA ADI√á√ÉO: Coletar CORRE√á√ïES ---
    const correcoes = {};
    const instagramCorrecaoCheck = document.getElementById(
      "corrigir_instagram_check"
    );
    const instagramCorrecaoValor = document.getElementById(
      "corrigir_instagram_valor"
    );
    const whatsappCorrecaoCheck = document.getElementById(
      "corrigir_whatsapp_check"
    );
    const whatsappCorrecaoObs = document.getElementById(
      "corrigir_whatsapp_obs"
    );
    const assessoresCorrecaoCheck = document.getElementById(
      "corrigir_assessores_check"
    );
    const assessoresCorrecaoObs = document.getElementById(
      "corrigir_assessores_obs"
    );

    if (
      instagramCorrecaoCheck &&
      instagramCorrecaoCheck.checked &&
      instagramCorrecaoValor &&
      instagramCorrecaoValor.value
    ) {
      correcoes.instagram = instagramCorrecaoValor.value.replace("@", ""); // Guarda o valor corrigido
    }
    if (
      whatsappCorrecaoCheck &&
      whatsappCorrecaoCheck.checked &&
      whatsappCorrecaoObs &&
      whatsappCorrecaoObs.value
    ) {
      correcoes.whatsapp_obs = whatsappCorrecaoObs.value; // Guarda a observa√ß√£o
    }
    if (
      assessoresCorrecaoCheck &&
      assessoresCorrecaoCheck.checked &&
      assessoresCorrecaoObs &&
      assessoresCorrecaoObs.value
    ) {
      correcoes.assessores_obs = assessoresCorrecaoObs.value; // Guarda a observa√ß√£o
    }
    // --- FIM DA ADI√á√ÉO ---

    const payload = {
      parlamentar_id: parlamentarId,
      parlamentar_nome: parlamentarNome,
      pauta_slug: pautaSlug,
      // Envia apenas se houver algo a adicionar
      dados_contato:
        Object.keys(dados_contato).length > 0 ? dados_contato : null,
      evidencia: evidencia,
      // Envia apenas se houver alguma corre√ß√£o
      correcoes: Object.keys(correcoes).length > 0 ? correcoes : null,
      // Usu√°rio (opcional)
      usuario_nome: document.getElementById("campo-usuario-nome").value || null,
      usuario_email:
        document.getElementById("campo-usuario-email").value || null,
    };

    // Verifica se h√° *algo* a ser enviado (novo dado, evid√™ncia ou corre√ß√£o)
    if (!payload.dados_contato && !payload.evidencia && !payload.correcoes) {
      alert(
        "‚ö†Ô∏è Nenhuma informa√ß√£o nova ou corre√ß√£o foi preenchida para enviar."
      );
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
      return; // Interrompe o envio se n√£o h√° nada
    }

    try {
      console.log("Enviando payload:", JSON.stringify(payload, null, 2)); // Log para debug
      const response = await fetch("/api/contribuir-dados", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json();

      if (data.success) {
        alert(
          "‚úÖ Contribui√ß√£o enviada com sucesso! Ser√° revisada pelo administrador."
        );
        $("#modalEnviarInfo").modal("hide");
      } else {
        console.error("Erro da API:", data.error);
        alert("‚ùå Erro ao enviar: " + (data.error || "Tente novamente"));
      }
    } catch (error) {
      console.error("Erro de rede/fetch:", error);
      alert(
        "‚ùå Erro de conex√£o ao enviar. Verifique sua rede e tente novamente."
      );
    } finally {
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });

function carregarContadores(listaParlamentares) {
  // Adiciona par√¢metro
  if (!listaParlamentares) listaParlamentares = []; // Garante que √© um array

  const totalEmails = listaParlamentares.filter((p) => p.email).length;
  const elEmails = document.getElementById("contador-emails");
  if (elEmails)
    elEmails.textContent = `${totalEmails} emails dispon√≠veis (API)`;

  const totalWhatsApp = listaParlamentares.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.whatsapp
  ).length;
  const elWhatsApp = document.getElementById("contador-whatsapp");
  if (elWhatsApp)
    elWhatsApp.textContent = `${totalWhatsApp} WhatsApps (comunidade)`;

  const totalInstagram = listaParlamentares.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.instagram
  ).length;
  const elInstagram = document.getElementById("contador-instagram");
  if (elInstagram)
    elInstagram.textContent = `${totalInstagram} perfis (comunidade)`;
}

// ==========================================
// FUN√á√ïES DE CAMPANHA (ATUALIZADAS)
// ==========================================

// NOVO: Fun√ß√£o auxiliar para gerar o prefixo
// ATUALIZADO: Fun√ß√£o auxiliar para gerar APENAS a frase de identifica√ß√£o
function gerarPrefixoMensagem(idSelectEstado, idInputNome) {
  const selectEstadoEl = document.getElementById(idSelectEstado);
  const inputNomeEl = document.getElementById(idInputNome);

  // Garantir que os elementos existem antes de tentar ler 'value'
  const estadoSelecionado = selectEstadoEl ? selectEstadoEl.value : null;
  const nomeUsuario = inputNomeEl ? inputNomeEl.value : null;

  let frase = "Sou Agente de Seguran√ßa Socioeducativo"; // Padr√£o

  if (estadoSelecionado && nomeUsuario) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    frase += ` do Estado do ${nomeEstado}, meu nome √© ${nomeUsuario}`;
  } else if (estadoSelecionado) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    frase += ` do Estado do ${nomeEstado}`;
  } else if (nomeUsuario) {
    frase += `, meu nome √© ${nomeUsuario}`;
  }

  return frase + "."; // Adiciona ponto final
}

// NOVO: Fun√ß√£o auxiliar para copiar
async function copiarParaClipboard(targetId, buttonEl) {
  const elemento = document.getElementById(targetId);
  let texto = elemento.value || elemento.textContent;

  if (!texto) return;

  try {
    await navigator.clipboard.writeText(texto);

    // Feedback visual
    const originalHtml = buttonEl.innerHTML; // Salva o SVG original
    buttonEl.innerHTML = "‚úÖ";
    buttonEl.style.color = "#28a745";
    buttonEl.title = "Copiado!"; // Atualiza o tooltip

    setTimeout(() => {
      buttonEl.innerHTML = originalHtml; // Restaura o SVG
      buttonEl.style.color = "#6c757d";
      // Restaura o title original (se precisar, pegue do HTML ou defina aqui)
      // Exemplo: buttonEl.title = 'Copiar lista de emails';
    }, 1500);
  } catch (err) {
    console.error("Falha ao copiar: ", err);
    alert("Falha ao copiar. Tente manualmente.");
  }
}

function abrirCampanhaEmail() {
  // Verifica se o objeto campanhaEmail existe e tem dados necess√°rios
  if (
    !campanhaEmail ||
    !campanhaEmail.assunto ||
    !campanhaEmail.mensagem_oposicao ||
    !campanhaEmail.mensagem_apoio
  ) {
    return alert(
      "Campanha de email n√£o configurada corretamente (faltando assunto ou mensagens de oposi√ß√£o/apoio)."
    );
  }

  // Elementos do DOM
  const selectEstado = document.getElementById("filtro-campanha-estado-email");
  const inputNome = document.getElementById("campo-nome-email");
  const textareaEmails = document.getElementById("emails-lista");
  const inputAssunto = document.getElementById("email-assunto");
  const textareaMensagem = document.getElementById("email-mensagem");
  const totalEmailsEl = document.getElementById("total-emails-campanha");
  const radiosObjetivo = document.querySelectorAll(
    'input[name="objetivoEmail"]'
  );

  // Templates de mensagem
  const templateOposicao = campanhaEmail.mensagem_oposicao || "";
  const templateApoio = campanhaEmail.mensagem_apoio || "";
  const templateExtra = campanhaEmail.mensagem_extra || "";

  // --- IN√çCIO DA CORRE√á√ÉO ---
  // Garante que a fun√ß√£o global est√° acess√≠vel
  if (typeof window.obterPosicao !== "function") {
    console.error(
      "ERRO CR√çTICO: A fun√ß√£o global obterPosicao n√£o foi encontrada!"
    );
    return alert(
      "Erro interno ao carregar a fun√ß√£o de posi√ß√£o. Contacte o suporte."
    );
  }
  // --- FIM DA CORRE√á√ÉO ---

  // Fun√ß√£o interna para atualizar a lista e a mensagem
  function atualizarFiltroEmail() {
    const estadoSelecionado = selectEstado ? selectEstado.value : ""; // Fallback
    const objetivoSelecionado =
      document.querySelector('input[name="objetivoEmail"]:checked')?.value ||
      "pedir";

    let parlamentaresFiltrados = [];
    let mensagemBase = templateOposicao;
    let tipoContagem = "(Oposi√ß√£o/Neutros)";
    let saudacaoGenerica = "Ol√°, Parlamentar,"; // Fallback

    if (casaLegislativa.includes("C√¢mara")) {
      saudacaoGenerica = "Ol√°, Deputado(a),";
    } else if (casaLegislativa.includes("Senado")) {
      saudacaoGenerica = "Ol√°, Senador(a),";
    }

    // --- IN√çCIO DA CORRE√á√ÉO ---
    // Garante que parlamentaresAtuaisParaTabela √© um array antes de filtrar
    const listaParaFiltrar = Array.isArray(parlamentaresAtuaisParaTabela)
      ? parlamentaresAtuaisParaTabela
      : [];
    // --- FIM DA CORRE√á√ÉO ---

    try {
      // Adiciona try...catch em volta do filter
      if (objetivoSelecionado === "agradecer") {
        parlamentaresFiltrados = listaParaFiltrar.filter((p) => {
          if (!p || typeof p !== "object") return false; // Sanity check
          const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
          const posicao = window.obterPosicao(p.id); // Chama a fun√ß√£o global explicitamente
          return estadoMatch && posicao === "apoia";
        });
        mensagemBase = templateApoio;
        tipoContagem = "(Apoiadores)";
      } else {
        // 'pedir' (padr√£o)
        parlamentaresFiltrados = listaParaFiltrar.filter((p) => {
          // << LINHA DO ERRO ORIGINAL
          if (!p || typeof p !== "object") return false; // Sanity check
          const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
          const posicao = window.obterPosicao(p.id); // Chama a fun√ß√£o global explicitamente
          return (
            estadoMatch &&
            (posicao === "contrario" || posicao === "nao-manifestado")
          );
        });
        mensagemBase = templateOposicao;
        tipoContagem = "(Oposi√ß√£o/Neutros)";
      }
    } catch (filterError) {
      console.error(
        "Erro durante a execu√ß√£o do filtro de parlamentares:",
        filterError
      );
      alert(
        "Ocorreu um erro ao filtrar os parlamentares. Verifique o console."
      );
      parlamentaresFiltrados = []; // Reseta em caso de erro
    }

    const emails = parlamentaresFiltrados
      .filter((p) => p && p.email)
      .map((p) => p.email); // Adicionado check p && p.email
    if (textareaEmails) textareaEmails.value = emails.join("; ");
    if (totalEmailsEl)
      totalEmailsEl.innerHTML = `<strong>${emails.length}</strong> email(s) selecionado(s) ${tipoContagem}`;

    const fraseIdentificacao = gerarPrefixoMensagem(
      "filtro-campanha-estado-email",
      "campo-nome-email"
    );
    let mensagemFinal = `${saudacaoGenerica}\n\n${fraseIdentificacao}\n\n${mensagemBase}`;

    if (templateExtra) {
      mensagemFinal += "\n\n---\n" + templateExtra;
    }

    if (inputAssunto) inputAssunto.value = campanhaEmail.assunto || "";
    if (textareaMensagem) textareaMensagem.value = mensagemFinal;
  }

  // Adicionar "ouvintes" de mudan√ßa
  if (selectEstado) selectEstado.onchange = atualizarFiltroEmail;
  if (inputNome) inputNome.oninput = atualizarFiltroEmail;
  radiosObjetivo.forEach((radio) => {
    radio.onchange = atualizarFiltroEmail;
  });

  // Chamar a fun√ß√£o uma vez para carregar o estado inicial
  atualizarFiltroEmail();

  // Abrir o modal
  if (typeof $ !== "undefined" && $.fn.modal) {
    $("#modalCampanhaEmail").modal("show");
  } else {
    console.error(
      "jQuery ou Bootstrap Modal n√£o carregado. N√£o √© poss√≠vel abrir o modal."
    );
    alert("Erro ao tentar abrir a janela da campanha.");
  }
}

function abrirClienteEmail() {
  const emails = document.getElementById("emails-lista").value;
  const assunto = document.getElementById("email-assunto").value;
  const mensagem = document.getElementById("email-mensagem").value;

  const mailto = `mailto:?bcc=${encodeURIComponent(
    emails
  )}&subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(
    mensagem
  )}`;

  if (mailto.length > 2000) {
    alert("‚ö†Ô∏è Muitos emails! Use os √≠cones de copiar manualmente.");
    return;
  }

  window.location.href = mailto;

  trackingData[pautaSlug].email = new Date().toISOString();
  salvarTracking();
  mostrarTracking();
}

// ATUALIZADO: CAMPANHA WHATSAPP
function abrirCampanhaWhatsApp() {
  if (!campanhaWhatsApp) return alert("Campanha de WhatsApp n√£o configurada.");

  // Armazena os templates em textareas escondidos
  document.getElementById("whatsapp-mensagem-oposicao").value =
    campanhaWhatsApp.mensagem_oposicao || "";
  document.getElementById("whatsapp-mensagem-apoio").value =
    campanhaWhatsApp.mensagem_apoio || "";

  const selectEstado = document.getElementById("filtro-campanha-estado-wa");
  const inputNome = document.getElementById("campo-nome-wa");

  // Adicionar listeners para atualizar a lista
  selectEstado.onchange = atualizarListaWhatsApp;
  inputNome.oninput = atualizarListaWhatsApp; // Atualiza ao digitar nome tamb√©m (para prefixo)

  atualizarListaWhatsApp();
  // Necess√°rio jQuery para abrir modal
  $("#modalCampanhaWhatsApp").modal("show");
}

function atualizarListaWhatsApp() {
  const listaEl = document.getElementById("lista-whatsapp");
  const totalEl = document.getElementById("total-whatsapp");
  const estadoSelecionado = document.getElementById(
    "filtro-campanha-estado-wa"
  ).value;

  let cargo = "Parlamentares";
  if (casaLegislativa.includes("C√¢mara")) cargo = "Deputados(as)";
  else if (casaLegislativa.includes("Senado")) cargo = "Senadores(as)";
  let textoEstado = "de todos os estados";
  if (estadoSelecionado)
    textoEstado = `do Estado do ${
      mapEstados[estadoSelecionado] || estadoSelecionado
    }`;

  const parlamentares = parlamentaresAtuaisParaTabela.filter((p) => {
    const temWhatsApp = congressistasExtras.congressistas?.[p.id]?.whatsapp;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temWhatsApp && estadoMatch;
  });

  const count = parlamentares.length;
  const enviados = trackingData[pautaSlug].whatsapp || [];

  if (count > 0) {
    totalEl.innerHTML = `Total: <strong>${count}</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
    listaEl.innerHTML = parlamentares
      .map((p) => {
        const jaEnviado = enviados.includes(p.id);
        const nomeEscapado = p.nome
          .replace(/'/g, "\\'")
          .replace(/"/g, "&quot;");
        // --- CORRE√á√ÉO: Removido 'disabled' ---
        return `<div class="parlamentar-envio-item ${
          jaEnviado ? "enviado" : ""
        }" data-id="${p.id}">
          <div>
            <strong>${p.nome}</strong> (${p.partido}-${p.uf})
            ${
              jaEnviado
                ? '<span style="color: #28a745; font-weight: bold; margin-left: 8px;">‚úÖ</span>'
                : ""
            }
          </div>
          <button class="btn btn-sm btn-success" onclick="enviarWhatsApp('${
            p.id
          }', '${nomeEscapado}')">
            ${whatsappIcon} Enviar ${jaEnviado ? " Novamente" : ""}
          </button>
        </div>`;
        // --- FIM DA CORRE√á√ÉO ---
      })
      .join("");
  } else {
    totalEl.innerHTML = `Total: <strong>0</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado}.`;
    listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">...</div>`; // Conte√∫do igual
  }
  atualizarProgressoWhatsApp();
}

function atualizarListaInstagram() {
  const listaEl = document.getElementById("lista-instagram");
  const totalEl = document.getElementById("total-instagram");
  const estadoSelecionado = document.getElementById(
    "filtro-campanha-estado-ig"
  ).value;

  let cargo = "Parlamentares";
  // ... (l√≥gica de texto igual) ...
  if (casaLegislativa.includes("C√¢mara")) cargo = "Deputados(as)";
  else if (casaLegislativa.includes("Senado")) cargo = "Senadores(as)";
  let textoEstado = "de todos os estados";
  if (estadoSelecionado)
    textoEstado = `do Estado do ${
      mapEstados[estadoSelecionado] || estadoSelecionado
    }`;

  const parlamentares = parlamentaresAtuaisParaTabela.filter((p) => {
    const temIg = congressistasExtras.congressistas?.[p.id]?.instagram;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temIg && estadoMatch;
  });

  const count = parlamentares.length;
  const enviados = trackingData[pautaSlug].instagram || [];

  if (count > 0) {
    totalEl.innerHTML = `Total: <strong>${count}</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
    listaEl.innerHTML = parlamentares
      .map((p) => {
        const jaEnviado = enviados.includes(p.id);
        const nomeEscapado = p.nome
          .replace(/'/g, "\\'")
          .replace(/"/g, "&quot;");
        // --- CORRE√á√ÉO: Removido 'disabled' ---
        return `<div class="parlamentar-envio-item ${
          jaEnviado ? "enviado" : ""
        }" data-id="${p.id}">
          <div>
            <strong>${p.nome}</strong> (${p.partido}-${p.uf})
            ${
              jaEnviado
                ? '<span style="color: #28a745; font-weight: bold; margin-left: 8px;">‚úÖ</span>'
                : ""
            }
          </div>
          <button class="btn btn-sm btn-danger" style="background-color: #E4405F; border: none;" onclick="enviarInstagram('${
            p.id
          }', '${nomeEscapado}')">
            ${instagramIcon} Abrir Direct ${jaEnviado ? " Novamente" : ""}
          </button>
        </div>`;
        // --- FIM DA CORRE√á√ÉO ---
      })
      .join("");
  } else {
    totalEl.innerHTML = `Total: <strong>0</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado}.`;
    listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">...</div>`; // Conte√∫do igual
  }
  atualizarProgressoInstagram();
}

function enviarWhatsApp(parlamentarId, nomeEscapado) {
  if (
    !campanhaWhatsApp ||
    !campanhaWhatsApp.mensagem_oposicao ||
    !campanhaWhatsApp.mensagem_apoio
  ) {
    return alert(
      "Campanha de WhatsApp n√£o configurada corretamente (mensagens faltando)."
    );
  }

  // Encontra o objeto parlamentar COMPLETO na lista da pauta atual
  const parlamentar = parlamentaresAtuaisParaTabela.find(
    (p) => p.id === parlamentarId
  );
  if (!parlamentar)
    return alert("Erro: Parlamentar n√£o encontrado nesta pauta.");

  const extras = congressistasExtras.congressistas[parlamentarId];
  let whatsapp = extras?.whatsapp;
  if (Array.isArray(whatsapp)) whatsapp = whatsapp[0];
  if (!whatsapp)
    return alert(
      `Erro: N√∫mero de WhatsApp n√£o cadastrado para ${parlamentar.nome}.`
    );

  const posicao = obterPosicao(parlamentarId);

  // --- IN√çCIO DA PERSONALIZA√á√ÉO ---
  // 1. Determinar Sauda√ß√£o Personalizada (com fallback)
  let saudacao = "Ol√°, Parlamentar,"; // Fallback gen√©rico
  if (parlamentar.casa === "C√¢mara") {
    saudacao =
      parlamentar.sexo === "F" ? "Ol√°, Deputada," : "Ol√°, Deputado(a),"; // Usa Deputado(a) como fallback se sexo != 'F'
    if (parlamentar.sexo === "M") saudacao = "Ol√°, Deputado,";
  } else if (parlamentar.casa === "Senado") {
    saudacao = parlamentar.sexo === "F" ? "Ol√°, Senadora," : "Ol√°, Senador(a),"; // Usa Senador(a) como fallback se sexo != 'F'
    if (parlamentar.sexo === "M") saudacao = "Ol√°, Senador,";
  }

  // 2. Escolher Template (Apoio ou Oposi√ß√£o)
  const templateOposicao = campanhaWhatsApp.mensagem_oposicao || "";
  const templateApoio = campanhaWhatsApp.mensagem_apoio || "";
  let mensagemBase = templateOposicao;
  if (posicao === "apoia" && templateApoio) {
    mensagemBase = templateApoio;
  }

  // 3. Gerar Frase de Identifica√ß√£o
  const fraseIdentificacao = gerarPrefixoMensagem(
    "filtro-campanha-estado-wa",
    "campo-nome-wa"
  );

  // 4. Montar Mensagem Final
  // Substitui [NOME] apenas na mensagem base, n√£o na sauda√ß√£o ou identifica√ß√£o
  const mensagem = `${saudacao}\n\n${fraseIdentificacao}\n\n${mensagemBase.replace(
    /\[NOME\]/g,
    parlamentar.nome
  )}`;
  // --- FIM DA PERSONALIZA√á√ÉO ---

  const url = `https://wa.me/55${whatsapp.replace(
    /\D/g,
    ""
  )}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, "_blank");

  // Tracking... (l√≥gica igual)
  if (!trackingData[pautaSlug].whatsapp) trackingData[pautaSlug].whatsapp = [];
  if (!trackingData[pautaSlug].whatsapp.includes(parlamentarId)) {
    trackingData[pautaSlug].whatsapp.push(parlamentarId);
  }
  salvarTracking();
  atualizarListaWhatsApp();
  mostrarTracking();
}

function atualizarProgressoWhatsApp() {
  // Calcular total com base nos parlamentares DESTA pauta
  const total = parlamentaresAtuaisParaTabela.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.whatsapp
  ).length;

  // --- IN√çCIO DA CORRE√á√ÉO ---
  // Calcular enviados √∫nicos usando Set
  const enviadosUnicos = new Set(trackingData[pautaSlug]?.whatsapp || []);
  const enviados = enviadosUnicos.size; // Usa .size do Set
  // --- FIM DA CORRE√á√ÉO ---

  const percent = total > 0 ? Math.round((enviados / total) * 100) : 0;

  const progressBar = document.getElementById("progress-whatsapp");
  if (progressBar) {
    progressBar.style.width = percent + "%";
    progressBar.textContent = `${enviados}/${total}`; // Mostra contagem √∫nica/total
    progressBar.setAttribute("aria-valuenow", enviados);
    progressBar.setAttribute("aria-valuemax", total);
  }
}

// ATUALIZADO: CAMPANHA INSTAGRAM
function abrirCampanhaInstagram() {
  if (!campanhaInstagram)
    return alert("Campanha de Instagram n√£o configurada.");

  document.getElementById("instagram-mensagem-oposicao").value =
    campanhaInstagram.mensagem_oposicao || "";
  document.getElementById("instagram-mensagem-apoio").value =
    campanhaInstagram.mensagem_apoio || "";

  const selectEstado = document.getElementById("filtro-campanha-estado-ig");
  const inputNome = document.getElementById("campo-nome-ig");

  selectEstado.onchange = atualizarListaInstagram;
  inputNome.oninput = atualizarListaInstagram; // Atualiza para prefixo

  atualizarListaInstagram();
  // Necess√°rio jQuery
  $("#modalCampanhaInstagram").modal("show");
}

function enviarInstagram(parlamentarId, nomeEscapado) {
  const templateOposicao =
    document.getElementById("instagram-mensagem-oposicao")?.value || "";
  const templateApoio =
    document.getElementById("instagram-mensagem-apoio")?.value || "";
  if (!templateOposicao || !templateApoio) {
    return alert(
      "Campanha de Instagram n√£o configurada corretamente (mensagens faltando nos templates ocultos)."
    );
  }

  // Encontra o objeto parlamentar COMPLETO na lista da pauta atual
  const parlamentar = parlamentaresAtuaisParaTabela.find(
    (p) => p.id === parlamentarId
  );
  if (!parlamentar)
    return alert("Erro: Parlamentar n√£o encontrado nesta pauta.");

  const extras = congressistasExtras.congressistas[parlamentarId];
  if (!extras || !extras.instagram)
    return alert(
      `Erro: Perfil do Instagram n√£o cadastrado para ${parlamentar.nome}.`
    );

  const posicao = obterPosicao(parlamentarId);

  // --- IN√çCIO DA PERSONALIZA√á√ÉO ---
  // 1. Determinar Sauda√ß√£o Personalizada (com fallback)
  let saudacao = "Ol√°, Parlamentar,"; // Fallback gen√©rico
  if (parlamentar.casa === "C√¢mara") {
    saudacao =
      parlamentar.sexo === "F" ? "Ol√°, Deputada," : "Ol√°, Deputado(a),";
    if (parlamentar.sexo === "M") saudacao = "Ol√°, Deputado,";
  } else if (parlamentar.casa === "Senado") {
    saudacao = parlamentar.sexo === "F" ? "Ol√°, Senadora," : "Ol√°, Senador(a),";
    if (parlamentar.sexo === "M") saudacao = "Ol√°, Senador,";
  }

  // 2. Escolher Template (Apoio ou Oposi√ß√£o)
  let mensagemBase = templateOposicao;
  if (posicao === "apoia") {
    // Usa apoio se dispon√≠vel
    mensagemBase = templateApoio;
  }

  // 3. Gerar Frase de Identifica√ß√£o
  const fraseIdentificacao = gerarPrefixoMensagem(
    "filtro-campanha-estado-ig",
    "campo-nome-ig"
  );

  // 4. Montar Mensagem Final
  const mensagem = `${saudacao}\n\n${fraseIdentificacao}\n\n${mensagemBase.replace(
    /\[NOME\]/g,
    parlamentar.nome
  )}`;
  // --- FIM DA PERSONALIZA√á√ÉO ---

  // Abrir link do Direct
  const instagramUser = extras.instagram.replace("@", "");
  const url = `https://ig.me/m/${instagramUser}`;
  window.open(url, "_blank");

  // Copiar mensagem e avisar (alert j√° melhorado)
  navigator.clipboard
    .writeText(mensagem)
    .then(() => {
      alert(
        `‚úÖ Mensagem Copiada!\n\n1. O Direct do Instagram para @${instagramUser} deve ter aberto em outra aba.\n2. Cole a mensagem copiada l√° e envie.`
      );
    })
    .catch((err) => {
      console.error("Falha ao copiar mensagem do Instagram:", err);
      prompt(
        "Falha ao copiar. Copie a mensagem abaixo e cole no Direct:",
        mensagem
      );
    });

  // Tracking... (l√≥gica igual)
  if (!trackingData[pautaSlug].instagram)
    trackingData[pautaSlug].instagram = [];
  if (!trackingData[pautaSlug].instagram.includes(parlamentarId)) {
    trackingData[pautaSlug].instagram.push(parlamentarId);
  }
  salvarTracking();
  atualizarListaInstagram();
  mostrarTracking();
}

function atualizarProgressoInstagram() {
  // Calcular total com base nos parlamentares DESTA pauta
  const total = parlamentaresAtuaisParaTabela.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.instagram
  ).length;

  // --- IN√çCIO DA CORRE√á√ÉO ---
  // Calcular enviados √∫nicos usando Set
  const enviadosUnicos = new Set(trackingData[pautaSlug]?.instagram || []);
  const enviados = enviadosUnicos.size; // Usa .size do Set
  // --- FIM DA CORRE√á√ÉO ---

  const percent = total > 0 ? Math.round((enviados / total) * 100) : 0;

  const progressBar = document.getElementById("progress-instagram");
  if (progressBar) {
    progressBar.style.width = percent + "%";
    progressBar.textContent = `${enviados}/${total}`; // Mostra contagem √∫nica/total
    progressBar.setAttribute("aria-valuenow", enviados);
    progressBar.setAttribute("aria-valuemax", total);
  }
}

// TRACKING
function salvarTracking() {
  try {
    localStorage.setItem("campanhas_tracking", JSON.stringify(trackingData));
  } catch (e) {
    console.error("Erro ao salvar tracking no localStorage:", e);
  }
}

function mostrarTracking() {
  const container = document.getElementById("tracking-container");
  const itemsEl = document.getElementById("tracking-items");
  if (!container || !itemsEl) return;

  const dados = trackingData[pautaSlug]; // Dados de envio do localStorage
  if (!dados) return;

  let temProgresso = false;
  let html = "";

  // Email (N√£o tem 'total', s√≥ se foi enviado ou n√£o)
  if (dados.email) {
    temProgresso = true;
    html += `<div class="tracking-item">
      <span>üìß Email</span>
      <span style="color: #28a745;">‚úÖ Enviado</span>
    </div>`;
  }

  // Calcular totais com base nos parlamentares DESTA pauta
  const totalWhatsApp = parlamentaresAtuaisParaTabela.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.whatsapp
  ).length;
  const totalInstagram = parlamentaresAtuaisParaTabela.filter(
    (p) => congressistasExtras.congressistas?.[p.id]?.instagram
  ).length;

  // --- IN√çCIO DA CORRE√á√ÉO ---
  // Calcular enviados √∫nicos usando Set para remover duplicatas do array
  const enviadosWhatsAppUnicos = new Set(dados.whatsapp || []);
  const enviadosInstagramUnicos = new Set(dados.instagram || []);
  // --- FIM DA CORRE√á√ÉO ---

  // WhatsApp
  if (enviadosWhatsAppUnicos.size > 0 || totalWhatsApp > 0) {
    // Mostra mesmo se for 0/X
    temProgresso = true;
    // --- USA .size do Set ---
    html += `<div class="tracking-item">
        <span>${whatsappIcon} WhatsApp</span>
        <span>${enviadosWhatsAppUnicos.size}/${totalWhatsApp}</span>
      </div>`;
    // --- FIM DA ALTERA√á√ÉO ---
  }

  // Instagram
  if (enviadosInstagramUnicos.size > 0 || totalInstagram > 0) {
    // Mostra mesmo se for 0/X
    temProgresso = true;
    // --- USA .size do Set ---
    html += `<div class="tracking-item">
        <span>${instagramIcon} Instagram</span>
        <span>${enviadosInstagramUnicos.size}/${totalInstagram}</span>
      </div>`;
    // --- FIM DA ALTERA√á√ÉO ---
  }

  if (temProgresso) {
    itemsEl.innerHTML = html;
    container.style.display = "block";
  } else {
    container.style.display = "none"; // Esconde se n√£o houver progresso algum
  }
}

function fecharTracking() {
  const container = document.getElementById("tracking-container");
  if (container) {
    container.style.display = "none";
  }
}
