---
layout: default
---

<div class="container">
  <div class="jumbotron">
    <h1 class="display-4">{{ page.title }}</h1>
    <p class="lead">{{ page.description }}</p>
    <hr class="my-4">
    <div class="row">
      <div class="col-md-6">
        <p><strong>Casa:</strong> {{ page.casa }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Status:</strong> {{ page.status }}</p>
      </div>
    </div>
  </div>

  <div class="content-section mb-5">
    {{ content }}
  </div>

  {% if page.campanha %}
  <div class="campanhas-section mb-5">
    <h3>üì¢ Mobiliza√ß√£o</h3>
    <p>Participe das campanhas de contato com os parlamentares. Basta clicar nos bot√µes abaixo para enviar mensagens pedindo apoio aos parlamentares:</p>
    
    <div class="row">
      {% if page.campanha.email %}
      <div class="col-md-4 mb-3">
        <button class="btn btn-primary btn-block" onclick="abrirCampanhaEmail()">
          üìß Campanha de Email
        </button>
        <small id="contador-emails" class="text-muted">Carregando...</small>
      </div>
      {% endif %}
      
      {% if page.campanha.whatsapp %}
      <div class="col-md-4 mb-3">
        <button class="btn btn-success btn-block" onclick="abrirCampanhaWhatsApp()">
          <span id="icon-whatsapp"></span> Campanha WhatsApp
        </button>
        <small id="contador-whatsapp" class="text-muted">Carregando...</small>
      </div>
      {% endif %}
      
      {% if page.campanha.instagram %}
      <div class="col-md-4 mb-3">
        <button class="btn btn-danger btn-block" onclick="abrirCampanhaInstagram()">
          <span id="icon-instagram"></span> Campanha Instagram
        </button>
        <small id="contador-instagram" class="text-muted">Carregando...</small>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">üîç Filtrar Parlamentares</h5>
      <div class="row">
        <div class="col-md-3">
          <input type="text" class="form-control" id="filtro-nome" placeholder="Nome do parlamentar">
        </div>
        <div class="col-md-2">
          <select class="form-control" id="filtro-estado">
            <option value="">Todos os Estados</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-control" id="filtro-posicao">
            <option value="">Todas as Posi√ß√µes</option>
            <option value="apoia">Apoia</option>
            <option value="contrario">Contr√°rio</option> <option value="nao-manifestado">N√£o se Manifestou</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped" id="tabela-parlamentares">
      <thead class="thead-dark">
        <tr>
          <th>Nome</th>
          <th>Partido</th>
          <th>Estado</th>
          <th>Posi√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela-parlamentares-corpo">
        <tr>
          <td colspan="6" style="text-align: center;">
            <div class="spinner-border" role="status">
              <span class="sr-only">Carregando...</span>
            </div>
            <p class="mt-2">Carregando parlamentares...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="modalVerContato" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Contatos: <span id="contato-nome"></span></h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" id="contato-conteudo"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalEnviarInfo" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enviar Informa√ß√µes: <span id="enviar-info-nome"></span></h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formEnviarInfo">
          <input type="hidden" id="parlamentar-id-hidden">
          <input type="hidden" id="parlamentar-nome-hidden">
          
          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Email e telefone do gabinete j√° v√™m das APIs oficiais da C√¢mara/Senado. 
            Use este formul√°rio para adicionar dados pessoais (WhatsApp, Instagram, assessores).
          </div>
          
          <h6>üì± Dados do Parlamentar que voc√™ tenha</h6>
          <div class="form-group">
            <label>WhatsApp do Parlamentar</label>
            <input type="text" class="form-control" id="campo-whatsapp" placeholder="(XX) XXXXX-XXXX">
            <small class="text-muted">Para contato direto via WhatsApp</small>
          </div>
          <div class="form-group">
            <label>Instagram do Parlamentar</label>
            <input type="text" class="form-control" id="campo-instagram" placeholder="@usuario">
            <small class="text-muted">Para campanhas nas redes sociais</small>
          </div>
          
          <h6>üë• Assessores</h6>
          <div id="assessores-lista"></div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="adicionarAssessor()">+ Adicionar Assessor</button>
          
          <hr>
          
          <h6>üìÑ Evid√™ncia de Posicionamento (Espec√≠fica desta Pauta)</h6>
          <div class="form-group">
            <label>Tipo de Evid√™ncia</label>
            <select class="form-control" id="campo-evidencia-tipo">
              <option value="link">Link/Not√≠cia</option>
              <option value="video">V√≠deo</option>
              <option value="audio">√Åudio</option>
              <option value="documento">Documento</option>
            </select>
          </div>
          <div class="form-group">
            <label>URL da Evid√™ncia</label>
            <input type="url" class="form-control" id="campo-evidencia-url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea class="form-control" id="campo-evidencia-desc" rows="2"></textarea>
          </div>
          
          <hr>
          
          <h6>üë§ Seus Dados (Para Contato)</h6>
          <div class="form-group">
            <label>Seu Nome</label>
            <input type="text" class="form-control" id="campo-usuario-nome" required>
          </div>
          <div class="form-group">
            <label>Seu Email</label>
            <input type="email" class="form-control" id="campo-usuario-email" required>
          </div>
          
          <button type="submit" class="btn btn-primary">‚úÖ Enviar Informa√ß√µes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalCampanhaEmail" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìß Campanha de Email</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label for="filtro-campanha-estado-email">
            <strong>Filtrar por seu Estado (Opcional)</strong>
          </label>
          <select class="form-control" id="filtro-campanha-estado-email">
            <option value="">Todos os Estados (Apenas quem n√£o apoia)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="campo-nome-email">Seu Nome (Opcional)</label>
          <input type="text" class="form-control" id="campo-nome-email" placeholder="Digite seu nome...">
        </div>
        
        <p><strong>Total:</strong> <span id="total-emails-campanha"></span></p>

        <div class="form-group position-relative">
          <label for="emails-lista">Lista de Emails (CCO)</label>
          <textarea class="form-control" id="emails-lista" rows="3" readonly></textarea>
          <span class="copy-icon" onclick="copiarParaClipboard('emails-lista', this)" title="Copiar lista de emails"></span>
        </div>
        
        <div class="form-group position-relative">
          <label for="email-assunto">Assunto</label>
          <input type="text" class="form-control" id="email-assunto">
          <span class="copy-icon" onclick="copiarParaClipboard('email-assunto', this)" title="Copiar assunto"></span>
        </div>
        
        <div class="form-group position-relative">
          <label for="email-mensagem">Mensagem</label>
          <textarea class="form-control" id="email-mensagem" rows="8"></textarea>
          <span class="copy-icon" onclick="copiarParaClipboard('email-mensagem', this)" title="Copiar mensagem"></span>
        </div>
        
        <button class="btn btn-primary" onclick="abrirClienteEmail()">üìß Abrir no Cliente de Email</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalCampanhaWhatsApp" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span id="icon-whatsapp-2"></span> Campanha WhatsApp</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label for="filtro-campanha-estado-wa">
            <strong>Filtrar por seu Estado (Opcional)</strong>
          </label>
          <select class="form-control" id="filtro-campanha-estado-wa">
            <option value="">Todos os Estados</option>
          </select>
        </div>

        <div class="form-group">
          <label for="campo-nome-wa">Seu Nome (Opcional)</label>
          <input type="text" class="form-control" id="campo-nome-wa" placeholder="Digite seu nome...">
        </div>

        <p><strong>Total:</strong> <span id="total-whatsapp"></span></p>
        <div class="progress mb-3">
          <div id="progress-whatsapp" class="progress-bar" role="progressbar" style="width: 0%">0/0</div>
        </div>
        
        <textarea id="whatsapp-mensagem-apoio" class="hidden-textarea"></textarea>
        <textarea id="whatsapp-mensagem-oposicao" class="hidden-textarea"></textarea>
        
        <div id="lista-whatsapp" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalCampanhaInstagram" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span id="icon-instagram-2"></span> Campanha Instagram</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label for="filtro-campanha-estado-ig">
            <strong>Filtrar por seu Estado (Opcional)</strong>
          </label>
          <select class="form-control" id="filtro-campanha-estado-ig">
            <option value="">Todos os Estados</option>
          </select>
        </div>

        <div class="form-group">
          <label for="campo-nome-ig">Seu Nome (Opcional)</label>
          <input type="text" class="form-control" id="campo-nome-ig" placeholder="Digite seu nome...">
        </div>

        <p><strong>Total:</strong> <span id="total-instagram"></span></p>
        <div class="progress mb-3">
          <div id="progress-instagram" class="progress-bar" role="progressbar" style="width: 0%">0/0</div>
        </div>
        
        <textarea id="instagram-mensagem-apoio" class="hidden-textarea"></textarea>
        <textarea id="instagram-mensagem-oposicao" class="hidden-textarea"></textarea>
        
        <div id="lista-instagram" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<div id="tracking-container" style="position: fixed; bottom: 20px; right: 20px; background: white; border: 2px solid #667eea; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 1000;">
  <h6 style="margin: 0 0 10px 0;">üìä Seu Progresso</h6>
  <div id="tracking-items"></div>
  <button onclick="fecharTracking()" style="margin-top: 10px; background: none; border: none; color: #999; font-size: 12px; cursor: pointer;">Fechar</button>
</div>

<style>
.badge-status {
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.badge-apoia { background: #d4edda; color: #155724; }
.badge-contrario { background: #f8d7da; color: #721c24; } /* ATUALIZADO */
.badge-nao-manifestado { background: #e2e3e5; color: #383d41; }

.contato-info {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}
.contato-info-titulo {
  font-weight: 600;
  margin-bottom: 8px;
  color: #333;
}
.contato-info-valor {
  color: #666;
  font-size: 14px;
}
.contato-fonte {
  font-size: 11px;
  color: #999;
  font-style: italic;
}

.btn-acao-contato {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
}
.btn-whatsapp {
  background: #25D366;
  color: white;
}
.btn-whatsapp:hover {
  background: #20BA5A;
  color: white;
}
.btn-instagram {
  background: #E4405F;
  color: white;
}
.btn-instagram:hover {
  background: #D32F4F;
  color: white;
}

.assessores-lista {
  margin-top: 10px;
}
.assessor-item {
  background: white;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 10px;
  border-left: 3px solid #667eea;
}

.parlamentar-envio-item {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 2px solid #e0e0e0;
}
.parlamentar-envio-item.enviado {
  background: #d4edda;
  border-color: #28a745;
  opacity: 0.7;
}

.tracking-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #e0e0e0;
  font-size: 14px;
}
.tracking-item:last-child {
  border-bottom: none;
}

/* NOVO: √çcone de Copiar */
.position-relative {
  position: relative;
}
.copy-icon {
  position: absolute;
  top: 50%;
  right: 12px;
  transform: translateY(-50%);
  cursor: pointer;
  color: #6c757d;
  opacity: 0.5;
  transition: opacity 0.2s;
  padding: 5px;
}
.copy-icon:hover {
  opacity: 1;
}
/* Alinhar √≠cone do input (assunto) */
input + .copy-icon {
  top: 45px; /* Ajuste para campos de input */
}
/* Alinhar √≠cone do textarea (mensagem) */
textarea + .copy-icon {
  top: 45px; /* Ajuste para campos de textarea */
}

/* NOVO: Esconder textareas de template */
.hidden-textarea {
  display: none;
}
</style>

<script>

// ==========================================
// √çCONES E MAPAS (NOVOS)
// ==========================================

const whatsappIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
</svg>`;

const instagramIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;">
  <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
</svg>`;

const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
  <path d="M13 0H6a2 2 0 0 0-2 2 2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 2 2 0 0 0 2-2V4a2 2 0 0 0-2-2 2 2 0 0 0-2-2zM2 4a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4z"/>
  <path d="M13.5 1a.5.5 0 0 0-.5.5V3h-2a.5.5 0 0 0 0 1h2v1.5a.5.5 0 0 0 1 0V4h1.5a.5.5 0 0 0 0-1H14V1.5a.5.5 0 0 0-.5-.5z"/>
</svg>`;

// Inserir √≠cones nos bot√µes
document.querySelectorAll('.copy-icon').forEach(el => el.innerHTML = copyIcon);
document.getElementById('icon-whatsapp').innerHTML = whatsappIcon;
document.getElementById('icon-instagram').innerHTML = instagramIcon;
document.getElementById('icon-whatsapp-2').innerHTML = whatsappIcon; // No modal
document.getElementById('icon-instagram-2').innerHTML = instagramIcon; // No modal

// NOVO: Mapa de Estados
const mapEstados = {
    'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'Amap√°', 'AM': 'Amazonas', 'BA': 'Bahia',
    'CE': 'Cear√°', 'DF': 'Distrito Federal', 'ES': 'Esp√≠rito Santo', 'GO': 'Goi√°s',
    'MA': 'Maranh√£o', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul', 'MG': 'Minas Gerais',
    'PA': 'Par√°', 'PB': 'Para√≠ba', 'PR': 'Paran√°', 'PE': 'Pernambuco', 'PI': 'Piau√≠',
    'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte', 'RS': 'Rio Grande do Sul',
    'RO': 'Rond√¥nia', 'RR': 'Roraima', 'SC': 'Santa Catarina', 'SP': 'S√£o Paulo',
    'SE': 'Sergipe', 'TO': 'Tocantins'
};

// ==========================================
// DADOS GLOBAIS
// ==========================================
const pautaSlug = "{{ page.slug | default: page.title | slugify }}";
const casaLegislativa = "{{ page.casa }}";

// Parlamentares - iniciar vazio e carregar das APIs
let parlamentaresBase = [];

// Extras de usu√°rios
let congressistasExtras = {};
try {
  const tempExtras = {{ site.data.congressistas_extras | jsonify }};
  congressistasExtras = tempExtras && tempExtras.congressistas ? tempExtras : { congressistas: {} };
} catch (e) {
  congressistasExtras = { congressistas: {} };
}
  
// Evid√™ncias
let evidenciasPautas = {};
try {
  const tempEvidencias = {{ site.data.evidencias_pautas | jsonify }};
  evidenciasPautas = tempEvidencias || { pautas: {} };
} catch (e) {
  evidenciasPautas = { pautas: {} };
}

// Campanhas (NOVA ESTRUTURA)
let campanhaEmail = {};
let campanhaWhatsApp = {};
let campanhaInstagram = {};

try { campanhaEmail = {{ page.campanha.email | jsonify }} || {}; } catch(e) {}
try { campanhaWhatsApp = {{ page.campanha.whatsapp | jsonify }} || {}; } catch(e) {}
try { campanhaInstagram = {{ page.campanha.instagram | jsonify }} || {}; } catch(e) {}

// Tracking
let trackingData = JSON.parse(localStorage.getItem('campanhas_tracking') || '{}');
if (!trackingData[pautaSlug]) {
  trackingData[pautaSlug] = { email: null, whatsapp: [], instagram: [] };
}

let assessorCount = 0;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìä Iniciando pauta...');
  carregarParlamentaresComCache(); // Fun√ß√£o de carregamento principal
});

// Tentar carregar do cache antes de buscar APIs
async function carregarParlamentaresComCache() {
  console.log('üîÑ Verificando cache de parlamentares...');
  
  // 1. Tentar localStorage (cache de 7 dias)
  try {
    const cacheLocal = localStorage.getItem('parlamentares_cache_v1');
    if (cacheLocal) {
      const parsed = JSON.parse(cacheLocal);
      const idade = Date.now() - parsed.timestamp;
      const seteDias = 7 * 24 * 60 * 60 * 1000;
      
      if (idade < seteDias && parsed.data && parsed.data.length > 0) {
        console.log('‚úÖ Usando cache local:', parsed.data.length, 'parlamentares');
        parlamentaresBase = parsed.data; // Usar a lista completa
        
        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      } else {
        console.log('‚è∞ Cache expirado ou vazio');
      }
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao ler cache local:', e);
  }
  
  // 2. Tentar arquivo de cache do site
  try {
    const response = await fetch('/parlamentares_cache.json');
    if (response.ok) {
      const cacheData = await response.json();
      const parlamentares = cacheData.parlamentares;
      
      if (parlamentares && parlamentares.length > 0) {
        console.log(`‚úÖ Cache do site carregado: ${parlamentares.length} parlamentares`);
        parlamentaresBase = parlamentares; // Usar a lista completa
        
        // Salvar no localStorage
        localStorage.setItem('parlamentares_cache_v1', JSON.stringify({
          data: parlamentares,
          timestamp: Date.now()
        }));
        
        // Renderizar com os dados do cache
        finalizarCarregamento();
        return; // Cache v√°lido, encerrar fun√ß√£o
      }
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Arquivo de cache n√£o dispon√≠vel:', e);
  }

  // SEM CACHE: Carregar das APIs (m√©todo de fallback)
  // Esta l√≥gica foi removida para simplificar e depender 100% do cache
  console.error('‚ùå Nenhum cache v√°lido encontrado. O carregamento das APIs ao vivo foi removido.');
  
  const tbody = document.getElementById('tabela-parlamentares-corpo');
  if (tbody) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados. Tente recarregar a p√°gina.</td></tr>';
  }
}

// Fun√ß√£o chamada ap√≥s o carregamento (do cache)
function finalizarCarregamento() {
  // Agora que temos a lista completa, filtramos pela Casa
  parlamentaresBase = parlamentaresBase.filter(p => {
    if (!casaLegislativa) return true;
    if (casaLegislativa.includes('C√¢mara') && p.casa === 'C√¢mara') return true;
    if (casaLegislativa.includes('Senado') && p.casa === 'Senado') return true;
    return false;
  });

  console.log('‚úÖ Total de parlamentares (filtrados):', parlamentaresBase.length);
  
  carregarEstados();
  renderTabela();
  carregarContadores();
  mostrarTracking();
}
  
// Carregar estados no filtro (ATUALIZADO)
function carregarEstados() {
  if (parlamentaresBase.length === 0) return;
  
  const estados = [...new Set(parlamentaresBase.map(p => p.uf))].sort();
  
  // Lista de todos os dropdowns de estado
  const selectsIds = [
    'filtro-estado', 
    'filtro-campanha-estado-email',
    'filtro-campanha-estado-wa',
    'filtro-campanha-estado-ig'
  ];
  
  selectsIds.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      // Manter a primeira op√ß√£o
      const primeiraOpcao = select.options[0].outerHTML;
      select.innerHTML = primeiraOpcao;
      
      estados.forEach(uf => {
        // Usar o mapa para mostrar o nome completo
        const nomeCompleto = mapEstados[uf] || uf;
        const option = new Option(`${uf} - ${nomeCompleto}`, uf);
        select.add(option);
      });
    }
  });
}

// Renderizar tabela
function renderTabela() {
  const tbody = document.getElementById('tabela-parlamentares-corpo');
  
  if (parlamentaresBase.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum parlamentar encontrado para esta Casa.</td></tr>';
    return;
  }
  
  const termoNome = document.getElementById('filtro-nome').value.toLowerCase();
  const termoEstado = document.getElementById('filtro-estado').value;
  const termoPosicao = document.getElementById('filtro-posicao').value;
  
  const filtrados = parlamentaresBase.filter(p => {
    const nomeMatch = p.nome.toLowerCase().includes(termoNome);
    const estadoMatch = !termoEstado || p.uf === termoEstado;
    const posicao = obterPosicao(p.id);
    const posicaoMatch = !termoPosicao || posicao === termoPosicao;
    return nomeMatch && estadoMatch && posicaoMatch;
  });

  if (filtrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum parlamentar encontrado com esses filtros.</td></tr>';
    return;
  }
  
  tbody.innerHTML = filtrados.map(p => {
    const posicao = obterPosicao(p.id);
    const badgeClass = posicao === 'apoia' ? 'badge-apoia' : 
                       posicao === 'contrario' ? 'badge-contrario' : 'badge-nao-manifestado'; // ATUALIZADO
    const statusTexto = posicao === 'apoia' ? 'Apoia' : 
                        posicao === 'contrario' ? 'Contr√°rio' : 'N√£o se Manifestou'; // ATUALIZADO
    
    return `<tr>
      <td>${p.nome}</td>
      <td>${p.partido}</td>
      <td>${p.uf}</td>
      <td><span class="badge-status ${badgeClass}">${statusTexto}</span></td>
      <td>
        <button class="btn btn-sm btn-info" onclick='verContato(${JSON.stringify(p)})'>Ver Contato</button>
        <button class="btn btn-sm btn-warning" onclick="abrirEnviarInfo('${p.id}', '${p.nome.replace(/'/g, "\\'")}')">Enviar Info</button>
      </td>
    </tr>`;
  }).join('');
}

// Obter posi√ß√£o (do YAML ou do global)
function obterPosicao(parlamentarId) {
  // 1. Tentar ler do 'key_players' da pauta (se existir)
  {% if page.key_players %}
    const keyPlayer = {{ page.key_players | jsonify }}.find(p => p.nome === parlamentaresBase.find(parl => parl.id === parlamentarId)?.nome);
    if (keyPlayer && keyPlayer.position) {
      return keyPlayer.position;
    }
  {% endif %}

  // 2. Tentar ler das evid√™ncias globais
  if (evidenciasPautas.pautas && evidenciasPautas.pautas[pautaSlug] && evidenciasPautas.pautas[pautaSlug][parlamentarId]) {
    return evidenciasPautas.pautas[pautaSlug][parlamentarId].posicao || 'nao-manifestado';
  }
  return 'nao-manifestado';
}

// Filtros
document.getElementById('filtro-nome')?.addEventListener('input', renderTabela);
document.getElementById('filtro-estado')?.addEventListener('change', renderTabela);
document.getElementById('filtro-posicao')?.addEventListener('change', renderTabela);

// VER CONTATO (sem mudan√ßas)
function verContato(parlamentar) {
  const extras = congressistasExtras.congressistas?.[parlamentar.id] || {};
  
  let html = '';
  html += '<div class="alert alert-info"><strong>üìã Dados Oficiais (API ' + parlamentar.casa + ')</strong></div>';
  
  if (parlamentar.email) {
    html += `<div class="contato-info">
      <div class="contato-info-titulo">üìß Email Oficial</div>
      <div class="contato-info-valor">${parlamentar.email}</div>
      <div class="contato-fonte">Fonte: API da ${parlamentar.casa}</div>
    </div>`;
  }
  
  if (parlamentar.telefone_gabinete) {
    html += `<div class="contato-info">
      <div class="contato-info-titulo">üìû Telefone do Gabinete</div>
      <div class="contato-info-valor">${parlamentar.telefone_gabinete}</div>
      <div class="contato-fonte">Fonte: API da ${parlamentar.casa}</div>
    </div>`;
  }
  
  if (extras.whatsapp || extras.instagram || (extras.assessores && extras.assessores.length > 0)) {
    html += '<div class="alert alert-success mt-3"><strong>üì± Dados da Comunidade (Contribui√ß√µes Aprovadas)</strong></div>';
    
    if (extras.whatsapp) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo"><span id="icon-whatsapp-contato"></span> WhatsApp Pessoal</div>`;
      
      const whatsappList = Array.isArray(extras.whatsapp) ? extras.whatsapp : [extras.whatsapp];
      
      whatsappList.forEach((numero, index) => {
        html += `<a href="https://wa.me/55${numero.replace(/\D/g, '')}" target="_blank" class="btn-acao-contato btn-whatsapp" style="margin: 5px 5px 5px 0;">
          <span id="icon-whatsapp-contato-btn"></span> ${whatsappList.length > 1 ? `WhatsApp ${index + 1}` : 'Enviar WhatsApp'}
        </a>`;
      });
      html += `<div class="contato-fonte">Contribu√≠do pela comunidade</div></div>`;
    }
    
    if (extras.instagram) {
      html += `<div class="contato-info">
        <div class="contato-info-titulo"><span id="icon-instagram-contato"></span> Instagram</div>
        <a href="https://instagram.com/${extras.instagram.replace('@', '')}" target="_blank" class="btn-acao-contato btn-instagram">
          <span id="icon-instagram-contato-btn"></span> @${extras.instagram.replace('@', '')}
        </a>
        <div class="contato-fonte">Contribu√≠do pela comunidade</div>
      </div>`;
    }
  } else {
    html += `<div class="alert alert-warning mt-3">
      ‚ö†Ô∏è Nenhum dado adicional da comunidade dispon√≠vel.
      <br><button class="btn btn-sm btn-primary mt-2" onclick="$('#modalVerContato').modal('hide'); abrirEnviarInfo('${parlamentar.id}', '${parlamentar.nome.replace(/'/g, "\\'")}')">
        Contribuir com Informa√ß√µes
      </button>
    </div>`;
  }
  
  document.getElementById('contato-nome').textContent = parlamentar.nome;
  document.getElementById('contato-conteudo').innerHTML = html;
  
  // Inserir √≠cones dinamicamente
  document.getElementById('icon-whatsapp-contato')?.insertAdjacentHTML('afterbegin', whatsappIcon);
  document.getElementById('icon-whatsapp-contato-btn')?.insertAdjacentHTML('afterbegin', whatsappIcon);
  document.getElementById('icon-instagram-contato')?.insertAdjacentHTML('afterbegin', instagramIcon);
  document.getElementById('icon-instagram-contato-btn')?.insertAdjacentHTML('afterbegin', instagramIcon);

  $('#modalVerContato').modal('show');
}


// ENVIAR INFO (sem mudan√ßas)
function abrirEnviarInfo(parlamentarId, nome) {
  document.getElementById('parlamentar-id-hidden').value = parlamentarId;
  document.getElementById('parlamentar-nome-hidden').value = nome;
  document.getElementById('enviar-info-nome').textContent = nome;
  document.getElementById('formEnviarInfo').reset();
  document.getElementById('assessores-lista').innerHTML = '';
  assessorCount = 0;
  $('#modalEnviarInfo').modal('show');
}
function adicionarAssessor() {
  assessorCount++;
  const html = `<div class="assessor-item mb-2" id="assessor-${assessorCount}">...</div>`; // (c√≥digo omitido por brevidade)
  document.getElementById('assessores-lista').insertAdjacentHTML('beforeend', html);
}
document.getElementById('formEnviarInfo')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  // (l√≥gica de submit omitida por brevidade)
  
  try {
    const response = await fetch('/api/contribuir-dados', { /* ... */ });
    const data = await response.json();
    if (data.success) {
      alert('‚úÖ Contribui√ß√£o enviada com sucesso! Ser√° revisada pelo administrador.');
      $('#modalEnviarInfo').modal('hide');
    } else {
      alert('‚ùå Erro: ' + (data.error || 'Tente novamente'));
    }
  } catch (error) {
    alert('‚ùå Erro ao enviar. Verifique sua conex√£o e tente novamente.');
  }
});

// CAMPANHAS - Contadores (sem mudan√ßas)
function carregarContadores() {
  if (parlamentaresBase.length === 0) return;
  const totalEmails = parlamentaresBase.filter(p => p.email).length;
  const elEmails = document.getElementById('contador-emails');
  if (elEmails) elEmails.textContent = `${totalEmails} emails dispon√≠veis (API)`;
  const totalWhatsApp = parlamentaresBase.filter(p => congressistasExtras.congressistas?.[p.id]?.whatsapp).length;
  const elWhatsApp = document.getElementById('contador-whatsapp');
  if (elWhatsApp) elWhatsApp.textContent = `${totalWhatsApp} WhatsApps (comunidade)`;
  const totalInstagram = parlamentaresBase.filter(p => congressistasExtras.congressistas?.[p.id]?.instagram).length;
  const elInstagram = document.getElementById('contador-instagram');
  if (elInstagram) elInstagram.textContent = `${totalInstagram} perfis (comunidade)`;
}

// ==========================================
// FUN√á√ïES DE CAMPANHA (ATUALIZADAS)
// ==========================================

// NOVO: Fun√ß√£o auxiliar para gerar o prefixo
function gerarPrefixoMensagem(idSelectEstado, idInputNome) {
  const estadoSelecionado = document.getElementById(idSelectEstado).value;
  const nomeUsuario = document.getElementById(idInputNome).value;
  
  let prefixo = "Sou Agente de Seguran√ßa Socioeducativo."; // Padr√£o
  
  if (estadoSelecionado) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo do Estado do ${nomeEstado}.`;
  }
  
  if (estadoSelecionado && nomeUsuario) {
    const nomeEstado = mapEstados[estadoSelecionado] || estadoSelecionado;
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo do Estado do ${nomeEstado}, meu nome √© ${nomeUsuario}.`;
  } else if (nomeUsuario) {
    // Caso n√£o selecione estado mas coloque o nome
    prefixo = `Sou Agente de Seguran√ßa Socioeducativo, meu nome √© ${nomeUsuario}.`;
  }
  
  return prefixo + "\n\n"; // Adiciona duas quebras de linha
}

// NOVO: Fun√ß√£o auxiliar para copiar
async function copiarParaClipboard(targetId, buttonEl) {
  const elemento = document.getElementById(targetId);
  let texto = elemento.value || elemento.textContent;
  
  if (!texto) return;

  try {
    await navigator.clipboard.writeText(texto);
    
    // Feedback visual
    const originalText = buttonEl.innerHTML;
    buttonEl.innerHTML = '‚úÖ';
    buttonEl.style.color = '#28a745';
    
    setTimeout(() => {
      buttonEl.innerHTML = originalText;
      buttonEl.style.color = '#6c757d';
    }, 1500);

  } catch (err) {
    console.error('Falha ao copiar: ', err);
    alert('Falha ao copiar. Tente manualmente.');
  }
}


// ATUALIZADO: CAMPANHA EMAIL
function abrirCampanhaEmail() {
  if (!campanhaEmail) return alert('Campanha de email n√£o configurada para esta pauta.');
  
  const selectEstado = document.getElementById('filtro-campanha-estado-email');
  const inputNome = document.getElementById('campo-nome-email');
  const textareaEmails = document.getElementById('emails-lista');
  const inputAssunto = document.getElementById('email-assunto');
  const textareaMensagem = document.getElementById('email-mensagem');
  const totalEmailsEl = document.getElementById('total-emails-campanha');

  // Templates de mensagem
  const templateOposicao = campanhaEmail.mensagem_oposicao || "";
  const templateApoio = campanhaEmail.mensagem_apoio || "";

  // Fun√ß√£o interna para atualizar a lista e a mensagem
  function atualizarFiltroEmail() {
    const estadoSelecionado = selectEstado.value;
    
    // 1. Filtrar Parlamentares
    // A campanha de email foca em quem N√ÉO apoia
    const parlamentaresFiltrados = parlamentaresBase.filter(p => {
      const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
      if (!estadoMatch) return false;

      const posicao = obterPosicao(p.id);
      return posicao === 'contrario' || posicao === 'nao-manifestado';
    });

    // 2. Montar a lista de emails
    const emails = parlamentaresFiltrados.filter(p => p.email).map(p => p.email);
    textareaEmails.value = emails.join('; ');
    totalEmailsEl.textContent = `${emails.length} emails selecionados (quem n√£o apoia)`;

    // 3. Montar a Mensagem
    const prefixo = gerarPrefixoMensagem('filtro-campanha-estado-email', 'campo-nome-email');
    
    // Campanha de email sempre usa o template de oposi√ß√£o
    const templateFinal = templateOposicao; 

    inputAssunto.value = campanhaEmail.assunto || '';
    textareaMensagem.value = prefixo + templateFinal;
  }

  // 4. Adicionar "ouvintes" de mudan√ßa
  selectEstado.onchange = atualizarFiltroEmail;
  inputNome.oninput = atualizarFiltroEmail;

  // 5. Chamar a fun√ß√£o uma vez para carregar o estado inicial
  atualizarFiltroEmail();
  
  // 6. Abrir o modal
  $('#modalCampanhaEmail').modal('show');
}

function abrirClienteEmail() {
  const emails = document.getElementById('emails-lista').value;
  const assunto = document.getElementById('email-assunto').value;
  const mensagem = document.getElementById('email-mensagem').value;
  
  const mailto = `mailto:?bcc=${encodeURIComponent(emails)}&subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(mensagem)}`;
  
  if (mailto.length > 2000) {
    alert('‚ö†Ô∏è Muitos emails! Use os √≠cones de copiar manualmente.');
    return;
  }
  
  window.location.href = mailto;
  
  trackingData[pautaSlug].email = new Date().toISOString();
  salvarTracking();
  mostrarTracking();
}

// ATUALIZADO: CAMPANHA WHATSAPP
function abrirCampanhaWhatsApp() {
  if (!campanhaWhatsApp) return alert('Campanha de WhatsApp n√£o configurada.');
  
  // Armazena os templates em textareas escondidos
  document.getElementById('whatsapp-mensagem-oposicao').value = campanhaWhatsApp.mensagem_oposicao || '';
  document.getElementById('whatsapp-mensagem-apoio').value = campanhaWhatsApp.mensagem_apoio || '';

  const selectEstado = document.getElementById('filtro-campanha-estado-wa');
  const inputNome = document.getElementById('campo-nome-wa');

  // Adicionar listeners para atualizar a lista
  selectEstado.onchange = atualizarListaWhatsApp;
  inputNome.oninput = atualizarListaWhatsApp;

  atualizarListaWhatsApp();
  $('#modalCampanhaWhatsApp').modal('show');
}

function atualizarListaWhatsApp() {
    const listaEl = document.getElementById('lista-whatsapp');
    const totalEl = document.getElementById('total-whatsapp');
    const estadoSelecionado = document.getElementById('filtro-campanha-estado-wa').value;

    // --- In√≠cio da Nova L√≥gica de Texto ---
    let cargo = "Parlamentares";
    if (casaLegislativa.includes('C√¢mara')) {
        cargo = "Deputados(as)";
    } else if (casaLegislativa.includes('Senado')) {
        cargo = "Senadores(as)";
    }

    let textoEstado = "de todos os estados";
    if (estadoSelecionado) {
        textoEstado = `do Estado do ${mapEstados[estadoSelecionado] || estadoSelecionado}`;
    }
    // --- Fim da Nova L√≥gica de Texto ---

    // Filtra parlamentares
    const parlamentares = parlamentaresBase.filter(p => {
        const temWhatsApp = congressistasExtras.congressistas?.[p.id]?.whatsapp;
        const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
        return temWhatsApp && estadoMatch;
    });
    
    const count = parlamentares.length;
    
    if (count > 0) {
        // Se encontrou parlamentares, atualiza o total e mostra a lista
        totalEl.innerHTML = `Total: <strong>${count}</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
        
        const enviados = trackingData[pautaSlug].whatsapp || [];
        
        listaEl.innerHTML = parlamentares.map(p => {
            const jaEnviado = enviados.includes(p.id);
            const posicao = obterPosicao(p.id);
            const corBotao = (posicao === 'apoia') ? 'btn-primary' : 'btn-success';
            const textoBotao = (posicao === 'apoia') ? 'Agradecer' : 'Enviar Pedido';

            return `<div class="parlamentar-envio-item ${jaEnviado ? 'enviado' : ''}" data-id="${p.id}">
            <div>
                <strong>${p.nome}</strong> (${p.partido}-${p.uf})
                ${jaEnviado ? '‚úÖ' : ''}
            </div>
            <button class="btn btn-sm ${corBotao}" onclick="enviarWhatsApp('${p.id}')" ${jaEnviado ? 'disabled' : ''}>
                <span id="icon-whatsapp-btn-${p.id}"></span> ${textoBotao}
            </button>
            </div>`;
        }).join('');
        
        // Inserir √≠cones dinamicamente
        parlamentares.forEach(p => {
            const iconEl = document.getElementById(`icon-whatsapp-btn-${p.id}`);
            if (iconEl) iconEl.innerHTML = whatsappIcon;
        });

    } else {
        // Se n√£o encontrou, atualiza o total e mostra o aviso
        totalEl.innerHTML = `Total: <strong>0</strong> WhatsApp(s) de <strong>${cargo}</strong> ${textoEstado}.`;
        
        listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">
            N√£o h√° nenhum WhatsApp cadastrado de <strong>${cargo}</strong> ${textoEstado}.
            <br><br>
            Caso voc√™ tenha, volte √† tabela principal e clique em <strong>"Enviar Info"</strong> para contribuir!
        </div>`;
    }
    
    atualizarProgressoWhatsApp();
}

function enviarWhatsApp(parlamentarId) {
  const parlamentar = parlamentaresBase.find(p => p.id === parlamentarId);
  const extras = congressistasExtras.congressistas[parlamentarId];
  const posicao = obterPosicao(parlamentarId);

  // 1. Gerar prefixo
  const prefixo = gerarPrefixoMensagem('filtro-campanha-estado-wa', 'campo-nome-wa');

  // 2. Escolher template (Oposi√ß√£o ou Agradecimento)
  const templateOposicao = document.getElementById('whatsapp-mensagem-oposicao').value;
  const templateApoio = document.getElementById('whatsapp-mensagem-apoio').value;
  
  let mensagemBase = templateOposicao; // Padr√£o
  if (posicao === 'apoia' && templateApoio) {
    mensagemBase = templateApoio;
  }

  // 3. Montar mensagem final
  const mensagem = (prefixo + mensagemBase)
    .replace(/\[NOME\]/g, parlamentar.nome)
    .replace(/\[ESTADO\]/g, parlamentar.uf); // [ESTADO] (do parlamentar) ainda √© suportado se o admin usar
  
  let whatsapp = extras.whatsapp;
  if (Array.isArray(whatsapp)) {
    whatsapp = whatsapp[0];
  }
  
  const url = `https://wa.me/55${whatsapp.replace(/\D/g, '')}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, '_blank');
  
  if (!trackingData[pautaSlug].whatsapp) trackingData[pautaSlug].whatsapp = [];
  if (!trackingData[pautaSlug].whatsapp.includes(parlamentarId)) {
    trackingData[pautaSlug].whatsapp.push(parlamentarId);
  }
  
  salvarTracking();
  atualizarListaWhatsApp();
  mostrarTracking();
}

function atualizarProgressoWhatsApp() {
  const estadoSelecionado = document.getElementById('filtro-campanha-estado-wa').value;
  const total = parlamentaresBase.filter(p => {
    const temWhatsApp = congressistasExtras.congressistas?.[p.id]?.whatsapp;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temWhatsApp && estadoMatch;
  }).length;
  
  // Conta enviados *apenas* da lista filtrada
  const enviados = (trackingData[pautaSlug].whatsapp || []).filter(id => {
    const p = parlamentaresBase.find(parl => parl.id === id);
    return !estadoSelecionado || p.uf === estadoSelecionado;
  }).length;

  const percent = total > 0 ? (enviados / total * 100) : 0;
  
  const progressBar = document.getElementById('progress-whatsapp');
  progressBar.style.width = percent + '%';
  progressBar.textContent = `${enviados}/${total}`;
}

// ATUALIZADO: CAMPANHA INSTAGRAM
function abrirCampanhaInstagram() {
  if (!campanhaInstagram) return alert('Campanha de Instagram n√£o configurada.');
  
  document.getElementById('instagram-mensagem-oposicao').value = campanhaInstagram.mensagem_oposicao || '';
  document.getElementById('instagram-mensagem-apoio').value = campanhaInstagram.mensagem_apoio || '';

  const selectEstado = document.getElementById('filtro-campanha-estado-ig');
  const inputNome = document.getElementById('campo-nome-ig');

  selectEstado.onchange = atualizarListaInstagram;
  inputNome.oninput = atualizarListaInstagram;

  atualizarListaInstagram();
  $('#modalCampanhaInstagram').modal('show');
}

function atualizarListaInstagram() {
    const listaEl = document.getElementById('lista-instagram');
    const totalEl = document.getElementById('total-instagram');
    const estadoSelecionado = document.getElementById('filtro-campanha-estado-ig').value;

    // --- In√≠cio da Nova L√≥gica de Texto ---
    let cargo = "Parlamentares";
    if (casaLegislativa.includes('C√¢mara')) {
        cargo = "Deputados(as)";
    } else if (casaLegislativa.includes('Senado')) {
        cargo = "Senadores(as)";
    }

    let textoEstado = "de todos os estados";
    if (estadoSelecionado) {
        textoEstado = `do Estado do ${mapEstados[estadoSelecionado] || estadoSelecionado}`;
    }
    // --- Fim da Nova L√≥gica de Texto ---

    // Filtra parlamentares
    const parlamentares = parlamentaresBase.filter(p => {
        const temIg = congressistasExtras.congressistas?.[p.id]?.instagram;
        const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
        return temIg && estadoMatch;
    });

    const count = parlamentares.length;

    if (count > 0) {
        // Se encontrou, mostra o total e a lista
        totalEl.innerHTML = `Total: <strong>${count}</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado} (via comunidade).`;
        
        const enviados = trackingData[pautaSlug].instagram || [];
        
        listaEl.innerHTML = parlamentares.map(p => {
            const jaEnviado = enviados.includes(p.id);
            const posicao = obterPosicao(p.id);
            const corBotao = (posicao === 'apoia') ? 'btn-primary' : 'btn-success';
            const textoBotao = (posicao === 'apoia') ? 'Agradecer' : 'Enviar Pedido';

            return `<div class="parlamentar-envio-item ${jaEnviado ? 'enviado' : ''}" data-id="${p.id}">
            <div>
                <strong>${p.nome}</strong> (${p.partido}-${p.uf})
                ${jaEnviado ? '‚úÖ' : ''}
            </div>
            <button class="btn btn-sm ${corBotao}" onclick="enviarInstagram('${p.id}')" ${jaEnviado ? 'disabled' : ''}>
                <span id="icon-ig-btn-${p.id}"></span> ${textoBotao}
            </button>
            </div>`;
        }).join('');

        parlamentares.forEach(p => {
            const iconEl = document.getElementById(`icon-ig-btn-${p.id}`);
            if (iconEl) iconEl.innerHTML = instagramIcon;
        });

    } else {
        // Se for zero, mostra o total e o aviso
        totalEl.innerHTML = `Total: <strong>0</strong> perfil(s) de <strong>${cargo}</strong> ${textoEstado}.`;
        
        listaEl.innerHTML = `<div class="alert alert-warning" style="margin: 10px; font-size: 14px;">
            N√£o h√° nenhum Instagram cadastrado de <strong>${cargo}</strong> ${textoEstado}.
            <br><br>
            Caso voc√™ tenha, volte √† tabela principal e clique em <strong>"Enviar Info"</strong> para contribuir!
        </div>`;
    }

    atualizarProgressoInstagram();
}

function enviarInstagram(parlamentarId) {
  // AVISO: Instagram n√£o permite pr√©-preencher a mensagem via link
  // Apenas abrimos o Direct
  
  const instagram = congressistasExtras.congressistas[parlamentarId].instagram.replace('@', '');
  const url = `https://ig.me/m/${instagram}`;
  window.open(url, '_blank');
  
  // Sugerir ao usu√°rio que copie a mensagem
  const posicao = obterPosicao(parlamentarId);
  const prefixo = gerarPrefixoMensagem('filtro-campanha-estado-ig', 'campo-nome-ig');
  const templateOposicao = document.getElementById('instagram-mensagem-oposicao').value;
  const templateApoio = document.getElementById('instagram-mensagem-apoio').value;
  
  let mensagemBase = templateOposicao;
  if (posicao === 'apoia' && templateApoio) {
    mensagemBase = templateApoio;
  }
  
  const mensagem = (prefixo + mensagemBase).replace(/\[NOME\]/g, parlamentaresBase.find(p => p.id === parlamentarId).nome);
  
  // Copia automaticamente para o usu√°rio colar no Direct
  navigator.clipboard.writeText(mensagem).then(() => {
    alert('A mensagem foi copiada para sua √°rea de transfer√™ncia. Cole-a no Direct do Instagram que acabou de abrir.');
  });
  
  if (!trackingData[pautaSlug].instagram) trackingData[pautaSlug].instagram = [];
  if (!trackingData[pausaSlug].instagram.includes(parlamentarId)) {
    trackingData[pautaSlug].instagram.push(parlamentarId);
  }
  
  salvarTracking();
  atualizarListaInstagram();
  mostrarTracking();
}

function atualizarProgressoInstagram() {
  const estadoSelecionado = document.getElementById('filtro-campanha-estado-ig').value;
  const total = parlamentaresBase.filter(p => {
    const temIg = congressistasExtras.congressistas?.[p.id]?.instagram;
    const estadoMatch = !estadoSelecionado || p.uf === estadoSelecionado;
    return temIg && estadoMatch;
  }).length;
  
  const enviados = (trackingData[pautaSlug].instagram || []).filter(id => {
    const p = parlamentaresBase.find(parl => parl.id === id);
    return !estadoSelecionado || p.uf === estadoSelecionado;
  }).length;

  const percent = total > 0 ? (enviados / total * 100) : 0;
  
  const progressBar = document.getElementById('progress-instagram');
  progressBar.style.width = percent + '%';
  progressBar.textContent = `${enviados}/${total}`;
}

// TRACKING (sem mudan√ßas)
function salvarTracking() {
  localStorage.setItem('campanhas_tracking', JSON.stringify(trackingData));
}
function mostrarTracking() {
  const dados = trackingData[pautaSlug];
  if (!dados) return;
  // (l√≥gica omitida por brevidade)
}
function fecharTracking() {
  document.getElementById('tracking-container').style.display = 'none';
}
</script>
